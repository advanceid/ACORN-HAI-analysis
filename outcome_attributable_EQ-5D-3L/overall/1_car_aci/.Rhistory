summary_rows <- list()
# 1) All countries
all_value_text <- collect_value_sets(all_countries)
summary_rows[["All countries"]] <- make_block(
label = "All countries",
filter_fun = function(df) df,
value_text = all_value_text
)
# 2) Income-specific blocks
for (income in income_groups) {
filter_fun <- function(df) dplyr::filter(df, country_income == income)
countries_in_block <- Reduce(union, lapply(df_all, function(x) {
unique(dplyr::filter(x, country_income == income)$country)
}))
value_text <- collect_value_sets(countries_in_block)
summary_rows[[income]] <- make_block(
label = income,
filter_fun = filter_fun,
value_text = value_text
)
}
summary_tbl <- bind_rows(summary_rows)
# Ensure column order (spanner needs contiguous columns)
summary_tbl <- summary_tbl %>%
dplyr::select(
`Infection type`, `Overall pathogen`, CRA, `3GCRE`, CRE, `Value set used`
)
# gt table
section_labels <- c("All countries/regions", income_groups)
gt_table <- summary_tbl %>%
gt() %>%
tab_spanner(
label = "Priority pathogens",
columns = c(CRA, `3GCRE`, CRE),
id = "mu"
) %>%
tab_options(
column_labels.border.top.color = "black",
column_labels.border.top.width = px(2),
column_labels.border.bottom.color = "black",
column_labels.border.bottom.width = px(2),
table_body.hlines.color = "white",
table_body.hlines.width = px(0),
table.border.bottom.color = "white",
table.border.bottom.width = px(0),
data_row.padding = px(0),
footnotes.padding = px(0)
) %>%
tab_style(
style = cell_borders(sides = "bottom", color = "black", weight = px(2)),
locations = cells_body(rows = nrow(summary_tbl))
) %>%
cols_width(
1 ~ px(130),
c(2:3, 5) ~ px(90),
4 ~ px(110),
6 ~ px(420)
) %>%
tab_style(
style = list(cell_text(weight = "bold")),
locations = cells_body(rows = `Infection type` %in% section_labels)
) %>%
cols_align(align = "center", columns = 2:ncol(summary_tbl)) %>%
cols_align(align = "left", columns = 1) %>%
tab_style(
style = cell_text(font = c("Times New Roman"), size = px(10)),
locations = list(
cells_title(groups = "title"),
cells_title(groups = "subtitle"),
cells_column_labels(),
cells_body()
)
) %>%
tab_style(
style = cell_text(font = c("Times New Roman"), size = px(10)),
locations = cells_footnotes()
) %>%
tab_style(
style = cell_text(font = c("Times New Roman"), size = px(10)),
locations = cells_source_notes()
) %>%
tab_style(
style = cell_text(font = "Times New Roman", size = px(10), weight = "bold"),
locations = cells_column_spanners(spanners = "mu")
) %>%
tab_style(
style = list(cell_text(weight = "bold", v_align = "middle")),
locations = cells_column_labels(columns = everything())
) %>%
cols_label(
`Infection type` = md("Infection syndromes"),
`Overall pathogen` = md("Overall pathogens<sup>#</sup>"),
CRA = md("CRA & CSA<sup>#</sup>"),
`3GCRE` = md("3GCRE & 3GCSE<sup>#</sup>"),
CRE = md("CRE & CSE<sup>#</sup>"),
`Value set used` = md("Value set used")
) %>%
tab_source_note(
html(
"<sup>#</sup> Values were EQ-5D-3L mean utility (standard deviation).<br>
Abbreviations: VAP = Ventilator-Associated Pneumonia, BSI = Bloodstream Infection, CRA = Carbapenem-resistant <i>Acinetobacter</i> spp., CSA = Carbapenem-susceptible <i>Acinetobacter</i> spp.,
3GCRE = Third-generation cephalosporin-resistant Enterobacterales, 3GCSE = Third-generation cephalosporin-susceptible Enterobacterales, CRE = Carbapenem-resistant Enterobacterales, CSE = Carbapenem-susceptible Enterobacterales."
)
)
# Save
gtsave(gt_table, filename = "output/table/value_set.html")
# Clear & load packages
rm(list = ls())
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr, tidyr, tibble, gt)
})
# Working directory & data
wd <- "./"; setwd(wd)
# all_eq: all pathogens combined (for Overall pathogen)
# df_all: list of 3 datasets (CRA, 3GCRE, CRE)
all_eq <- readRDS("data/att_eq_all.RData")
df_all <- readRDS("data/att_eq.RData")
format_mean_sd <- function(x) {
if (length(na.omit(x)) == 0) return("NA")
sprintf("%.2f (%.2f)", mean(x, na.rm = TRUE), sd(x, na.rm = TRUE))
}
# Infection types order
infection_levels <- c("VAP", "Hospital-acquired BSI", "Healthcare-associated BSI")
# Priority pathogen labels (matching df_all order)
res_names <- c("CRA", "3GCRE", "CRE")
# Country to value-set mapping
value_map <- list(
list(countries = c("Singapore","Brunei","Hong Kong SAR China"),
text = "Singapore (Singapore/Brunei/Hong Kong SAR China)"),
list(countries = "Japan", text = "Japan"),
list(countries = "Taiwan", text = "Taiwan"),
list(countries = "China", text = "China"),
list(countries = "Malaysia", text = "Malaysia"),
list(countries = c("Thailand","Mongolia","Indonesia"),
text = "Thailand (Thailand/Mongolia/Indonesia)"),
list(countries = "Sri Lanka", text = "Sri Lanka"),
list(countries = c("Bangladesh","Nepal","Cambodia","Philippines",
"Pakistan","Timor-Leste","Vietnam","India"),
text = "Pakistan (Pakistan/Bangladesh/Nepal/Cambodia/Philippines/Timor-Leste/Vietnam/India)")
)
# Collect value-set strings for a set of countries (unique, preserve order)
collect_value_sets <- function(cntrs) {
texts <- vapply(value_map, function(block) {
if (any(block$countries %in% cntrs)) block$text else NA_character_
}, FUN.VALUE = character(1))
texts <- texts[!is.na(texts)]
texts <- unique(texts)
if (length(texts) == 0) "" else paste(texts, collapse = ", ")
}
# Income groups (used for blocks)
income_groups <- if (is.factor(df_all[[1]]$country_income)) {
levels(df_all[[1]]$country_income)
} else {
unique(df_all[[1]]$country_income)
}
# All countries present in dataset
all_countries <- Reduce(union, lapply(df_all, function(x) unique(x$country)))
View(df_all)
View(df_all[[1]])
# Clear & load packages
rm(list = ls())
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr, tidyr, tibble, gt)
})
# Working directory & data
wd <- "./"; setwd(wd)
# all_eq: all pathogens combined (for Overall pathogen)
# df_all: list of 3 datasets (CRA, 3GCRE, CRE)
all_eq <- readRDS("data/att_eq_all.RData")
df_all <- readRDS("data/att_eq.RData")
format_mean_sd <- function(x) {
if (length(na.omit(x)) == 0) return("NA")
sprintf("%.2f (%.2f)", mean(x, na.rm = TRUE), sd(x, na.rm = TRUE))
}
# Infection types order
infection_levels <- c("VAP", "Hospital-acquired BSI", "Healthcare-associated BSI")
# Priority pathogen labels (matching df_all order)
res_names <- c("CRA", "3GCRE", "CRE")
# Country to value-set mapping
value_map <- list(
list(countries = c("Singapore","Brunei","Hong Kong SAR China"),
text = "Singapore (Singapore/Brunei/Hong Kong SAR China)"),
list(countries = "Japan", text = "Japan"),
list(countries = "Taiwan", text = "Taiwan"),
list(countries = "China", text = "China"),
list(countries = "Malaysia", text = "Malaysia"),
list(countries = c("Thailand","Mongolia","Indonesia"),
text = "Thailand (Thailand/Mongolia/Indonesia)"),
list(countries = "Sri Lanka", text = "Sri Lanka"),
list(countries = c("Bangladesh","Nepal","Cambodia","Philippines",
"Pakistan","Timor-Leste","Vietnam","India"),
text = "Pakistan (Pakistan/Bangladesh/Nepal/Cambodia/Philippines/Timor-Leste/Vietnam/India)")
)
# Collect value-set strings for a set of countries (unique, preserve order)
collect_value_sets <- function(cntrs) {
texts <- vapply(value_map, function(block) {
if (any(block$countries %in% cntrs)) block$text else NA_character_
}, FUN.VALUE = character(1))
texts <- texts[!is.na(texts)]
texts <- unique(texts)
if (length(texts) == 0) "" else paste(texts, collapse = ", ")
}
# Income groups (used for blocks)
income_groups <- if (is.factor(df_all[[1]]$country_income)) {
levels(df_all[[1]]$country_income)
} else {
unique(df_all[[1]]$country_income)
}
# All countries present in dataset
all_countries <- Reduce(union, lapply(df_all, function(x) unique(x$country)))
# Block builder
make_block <- function(label, filter_fun, value_text) {
rows <- c("Overall", infection_levels)
row_df <- tibble(`Infection type` = rows)
# Priority pathogens
for (i in seq_along(df_all)) {
df <- filter_fun(df_all[[i]])
val_overall <- format_mean_sd(df$eq_5d_3l)
vals_by_inf <- df %>%
group_by(infection_types) %>%
summarise(val = format_mean_sd(eq_5d_3l), .groups = "drop") %>%
complete(infection_types = infection_levels, fill = list(val = "NA")) %>%
arrange(factor(infection_types, levels = infection_levels)) %>%
pull(val)
row_df[[res_names[i]]] <- c(val_overall, vals_by_inf)
}
# Overall pathogen (use all_eq)
df_all_overall <- filter_fun(all_eq)
val_overall_all <- format_mean_sd(df_all_overall$eq_5d_3l)
vals_by_inf_all <- df_all_overall %>%
group_by(infection_types) %>%
summarise(val = format_mean_sd(eq_5d_3l), .groups = "drop") %>%
complete(infection_types = infection_levels, fill = list(val = "NA")) %>%
arrange(factor(infection_types, levels = infection_levels)) %>%
pull(val)
row_df[["Overall pathogen"]] <- c(val_overall_all, vals_by_inf_all)
# Add value set description (only on the first row of each block)
row_df$`Value set used` <- c(value_text, rep("", nrow(row_df) - 1))
# Section header row (visual separation)
section_row <- tibble(
`Infection type` = label,
CRA = "", `3GCRE` = "", CRE = "",
`Overall pathogen` = "", `Value set used` = ""
)
bind_rows(section_row, row_df)
}
# Build summary table
summary_rows <- list()
# 1) All countries/regions
all_value_text <- collect_value_sets(all_countries)
summary_rows[["All countries/regions"]] <- make_block(
label = "All countries/regions",
filter_fun = function(df) df,
value_text = all_value_text
)
# 2) Income-specific blocks
for (income in income_groups) {
filter_fun <- function(df) dplyr::filter(df, country_income == income)
countries_in_block <- Reduce(union, lapply(df_all, function(x) {
unique(dplyr::filter(x, country_income == income)$country)
}))
value_text <- collect_value_sets(countries_in_block)
summary_rows[[income]] <- make_block(
label = income,
filter_fun = filter_fun,
value_text = value_text
)
}
summary_tbl <- bind_rows(summary_rows)
# Ensure column order (spanner needs contiguous columns)
summary_tbl <- summary_tbl %>%
dplyr::select(
`Infection type`, `Overall pathogen`, CRA, `3GCRE`, CRE, `Value set used`
)
# gt table
section_labels <- c("All countries/regions", income_groups)
gt_table <- summary_tbl %>%
gt() %>%
tab_spanner(
label = "Priority pathogens",
columns = c(CRA, `3GCRE`, CRE),
id = "mu"
) %>%
tab_options(
column_labels.border.top.color = "black",
column_labels.border.top.width = px(2),
column_labels.border.bottom.color = "black",
column_labels.border.bottom.width = px(2),
table_body.hlines.color = "white",
table_body.hlines.width = px(0),
table.border.bottom.color = "white",
table.border.bottom.width = px(0),
data_row.padding = px(0),
footnotes.padding = px(0)
) %>%
tab_style(
style = cell_borders(sides = "bottom", color = "black", weight = px(2)),
locations = cells_body(rows = nrow(summary_tbl))
) %>%
cols_width(
1 ~ px(130),
c(2:3, 5) ~ px(90),
4 ~ px(110),
6 ~ px(420)
) %>%
tab_style(
style = list(cell_text(weight = "bold")),
locations = cells_body(rows = `Infection type` %in% section_labels)
) %>%
cols_align(align = "center", columns = 2:ncol(summary_tbl)) %>%
cols_align(align = "left", columns = 1) %>%
tab_style(
style = cell_text(font = c("Times New Roman"), size = px(10)),
locations = list(
cells_title(groups = "title"),
cells_title(groups = "subtitle"),
cells_column_labels(),
cells_body()
)
) %>%
tab_style(
style = cell_text(font = c("Times New Roman"), size = px(10)),
locations = cells_footnotes()
) %>%
tab_style(
style = cell_text(font = c("Times New Roman"), size = px(10)),
locations = cells_source_notes()
) %>%
tab_style(
style = cell_text(font = "Times New Roman", size = px(10), weight = "bold"),
locations = cells_column_spanners(spanners = "mu")
) %>%
tab_style(
style = list(cell_text(weight = "bold", v_align = "middle")),
locations = cells_column_labels(columns = everything())
) %>%
cols_label(
`Infection type` = md("Infection syndromes"),
`Overall pathogen` = md("Overall pathogens<sup>#</sup>"),
CRA = md("CRA & CSA<sup>#</sup>"),
`3GCRE` = md("3GCRE & 3GCSE<sup>#</sup>"),
CRE = md("CRE & CSE<sup>#</sup>"),
`Value set used` = md("Value set used")
) %>%
tab_source_note(
html(
"<sup>#</sup> Values were EQ-5D-3L mean utility (standard deviation).<br>
Abbreviations: VAP = Ventilator-Associated Pneumonia, BSI = Bloodstream Infection, CRA = Carbapenem-resistant <i>Acinetobacter</i> spp., CSA = Carbapenem-susceptible <i>Acinetobacter</i> spp.,
3GCRE = Third-generation cephalosporin-resistant Enterobacterales, 3GCSE = Third-generation cephalosporin-susceptible Enterobacterales, CRE = Carbapenem-resistant Enterobacterales, CSE = Carbapenem-susceptible Enterobacterales."
)
)
# Save
gtsave(gt_table, filename = "output/table/value_set.html")
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 300) {
pdf_image <- image_read_pdf(input_pdf, density = dpi) # Read PDF with specified DPI
image_write(pdf_image, path = output_png, format = "png") # Write as PNG
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file) # Replace .pdf extension with .png
pdf_to_png(file, png_file)
}
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 300) {
pdf_image <- image_read_pdf(input_pdf, density = dpi) # Read PDF with specified DPI
image_write(pdf_image, path = output_png, format = "png") # Write as PNG
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file) # Replace .pdf extension with .png
pdf_to_png(file, png_file)
}
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 1000) {
pdf_image <- image_read_pdf(input_pdf, density = dpi)
image_write(pdf_image, path = output_png, format = "png")
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file) # Replace .pdf extension with .png
pdf_to_png(file, png_file)
}
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(magrittr,
dplyr,
labelled,
openxlsx)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
df <- readRDS("data/clean_data_RData/data_table_index_new_delete.RData")
# Check for NA values in critical columns
columns_to_check <- c(
"eq_5d_3l_1", "eq_5d_3l_2", "eq_5d_3l_3",
"eq_5d_3l_4", "eq_5d_3l_5"
)
df_clean <- df[complete.cases(df[, columns_to_check]), ]
# Universal function to filter and clean data
process_data_subset <- function(df, filter_column) {
if (!filter_column %in% colnames(df)) return(NULL)
df <- df %>% filter(!is.na(.data[[filter_column]]))
# Subject more than 12 years old
df <- df %>% filter(age_new >= 12)
# Relevel factors
df$pathogen_combined_types <- droplevels(df$pathogen_combined_types)
df$icu_hd_ap <- relevel(df$icu_hd_ap, ref = "No")
# Set variable labels
labels <- list(
sex = "Sex",
age_new = "Age (years)",
country_region = "Region",
country_income = "World Bank income status",
hpd_admreason = "Primary admission reason",
icu_hd_ap = "Admission to ICU/HD at enrollment",
comorbidities_CCI = "Charlson comorbidity index",
sofa_score = "SOFA score",
severity_score_scale = "Severity score of disease",
fbis_score = "FBIS score",
pitt_score = "PITT score",
qpitt_score = "qPITT score"
)
for (col in names(labels)) {
if (col %in% colnames(df)) {
df <- labelled::set_variable_labels(df, !!sym(col) := labels[[col]])
}
}
return(df)
}
# Function to relevel factors ending with "-susceptible"
relevel_factors_by_suffix <- function(df) {
factor_columns <- colnames(df)[sapply(df, is.factor)]
for (col in factor_columns) {
levels_col <- levels(df[[col]])
if (any(grepl("-susceptible$", levels_col))) {
ref_level <- grep("-susceptible$", levels_col, value = TRUE)
if (length(ref_level) == 1) {
df[[col]] <- relevel(df[[col]], ref = ref_level)
}
}
}
return(df)
}
# Filter and clean subsets for different pathogens
pathogen_columns <- c("aci_car", "ent_thir", "ent_car")
df_used <- lapply(pathogen_columns, function(col) process_data_subset(df_clean, col))
# Apply releveling to each subset in df_used
df_used <- lapply(df_used, function(sub_df) {
if (!is.null(sub_df)) {
sub_df <- relevel_factors_by_suffix(sub_df)
}
return(sub_df)
})
# All pathogens, subject more than 12 years old
df_clean2 <- df_clean %>% filter(age_new >= 12)
# Save data
saveRDS(df_clean2, "data/att_eq_all.RData")
saveRDS(df_used, "data/att_eq.RData")
###
source("~/Dropbox (Personal)/ACORN_2025_09_08/outcomes/ATT_EQ-5D-3L/overall/1_car_aci/0_combine_data.R", echo = TRUE)
source("~/Dropbox (Personal)/ACORN_2025_09_08/outcomes/ATT_EQ-5D-3L/overall/1_car_aci/1_value_set_all.R", echo = TRUE)
source("~/Dropbox (Personal)/ACORN_2025_09_08/outcomes/ATT_EQ-5D-3L/overall/1_car_aci/pdfcrop.R", echo = TRUE)
