style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = list(
cells_title(groups = "title"),
cells_title(groups = "subtitle"),
cells_column_labels(),
cells_body()
)
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = cells_source_notes()
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10),
weight = "bold"
),
locations = cells_column_spanners(spanners = tidyselect::matches("analysis"))
)
print(table)
#
gtsave(data = table, filename = "output/table/table_analysis.html")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
fastDummies,
semhelpinghands,
lavaan)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
df_all <- readRDS("data/att_eq.RData")
df <- as.data.frame(df_all[[2]])
# Ensure `ent_thir` is numeric
df$ent_thir <- ifelse(grepl("resistant$", df$ent_thir), 1, 0)
# Define SEM model
sem_model <- '
# 1. Define latent variable eq_5d_3l_latent
eq_5d_3l_latent =~ eq_5d_3l_1 + eq_5d_3l_4 + eq_5d_3l_5
out =~ eq_5d_3l_2 + eq_5d_3l_3
# 2. Structural equation model
eq_5d_3l_latent ~ age_new + sex + comorbidities_CCI + severity_score_scale + icu_hd_ap + pathogen_combined_types + ent_thir
out ~ eq_5d_3l_latent
'
# Run SEM
fit <- sem(sem_model, data = df, se = "bootstrap", bootstrap = 1000)
ci_boot <- standardizedSolution_boot_ci(fit)
param_est <- parameterEstimates(fit, standardized = TRUE, ci = TRUE)
# Coef
important_vars <- c("age_new", "sex", "comorbidities_CCI", "severity_score_scale", "icu_hd_ap", "pathogen_combined_types", "ent_thir")
S_coef_values <- ci_boot %>%
filter(lhs == "eq_5d_3l_latent" & rhs %in% important_vars)%>%
select(rhs, est.std, boot.ci.lower, boot.ci.upper, pvalue) %>%
mutate(pvalue = ifelse(pvalue < 0.001, "<0.001",
ifelse(pvalue < 0.01, sprintf("%.3f", pvalue),
sprintf("%.2f", pvalue)))) %>%
mutate(
est.std = round(est.std, 2),
boot.ci.lower = round(boot.ci.lower, 2),
boot.ci.upper = round(boot.ci.upper, 2)
) %>%
mutate(`S_coef (95%CI)` = paste0(est.std, " [", boot.ci.lower, ", ", boot.ci.upper, "]"))
U_coef_values <- param_est %>%
filter(lhs == "eq_5d_3l_latent" & rhs %in% important_vars) %>%
select(rhs, est, ci.lower, ci.upper, pvalue) %>%
mutate(pvalue = ifelse(pvalue < 0.001, "<0.001",
ifelse(pvalue < 0.01, sprintf("%.3f", pvalue),
sprintf("%.2f", pvalue))))%>%
mutate(
est = round(est, 2),
ci.lower = round(ci.lower, 2),
ci.upper = round(ci.upper, 2)
) %>%
mutate(`coef (95%CI)` = paste0(est, " [", ci.lower, ", ", ci.upper, "]"))
coef_df <- left_join(U_coef_values, S_coef_values, by = "rhs")
#
rows <- list(
c("Characteristics", NA, NA, NA, "Unstandardized coefficient (95%CI)", "p.value", NA, NA, NA, "Standardized coefficient (95%CI)"),
c("Age", rep(NA,9)),
c(NA, coef_df[1, c(2:4, 6, 5, 7:10)]),
c("Sex", rep(NA,9)),
c("Female", NA, NA, NA, "Ref", rep(NA,5)),
c("Male", coef_df[2, c(2:4, 6, 5, 7:10)]),
c("Charlson comorbidity index", rep(NA,9)),
c(NA, coef_df[3, c(2:4, 6, 5, 7:10)]),
c("Severity score of disease", rep(NA,9)),
c(NA, coef_df[4, c(2:4, 6, 5, 7:10)]),
c("Admission to ICU/HD at enrollment", rep(NA,9)),
c("No", NA, NA, NA, "Ref", rep(NA,5)),
c("Yes", coef_df[5, c(2:4, 6, 5, 7:10)]),
c("Type of pathogens", rep(NA,9)),
c("Monomicrobial",  NA, NA, NA, "Ref", rep(NA,5)),
c("Polymicrobial", coef_df[6, c(2:4, 6, 5, 7:10)]),
c("Enterobacterales", rep(NA,9)),
c("Third-generation cephalosporin-susceptible", NA, NA, NA, "Ref", rep(NA,5)),
c("Third-generation cephalosporin-resistant", coef_df[7, c(2:4, 6, 5, 7:10)]))
# Bind the rows into a matrix
result <- do.call(rbind, rows)
#
result <- as.data.frame(result)
result[, c(5:6, 10)] <- lapply(result[, c(5:6, 10)], as.character)
result[, c(2:4, 7:9)] <- lapply(result[, c(2:4, 7:9)], as.numeric)
# Save data
saveRDS(result, "data/attfbis_table_multi_1.RData")
# Rename
S_coef_values <- S_coef_values %>%
mutate(rhs = case_when(
rhs == "age_new" ~ "Age (years)",
rhs == "sex" ~ "Male (vs female)",
rhs == "comorbidities_CCI" ~ "Charlson comorbidity index",
rhs == "severity_score_scale" ~ "Severity score of disease",
rhs == "icu_hd_ap" ~ "Admission to ICU/HD at enrollment (yes vs no)",
rhs == "pathogen_combined_types" ~ "Polymicrobial (vs monomicrobial)",
rhs == "ent_thir" ~ "3GCRE (vs 3GCSE)",
TRUE ~ rhs
))
# Factor load
factor_load_eq <- ci_boot %>%
filter(lhs %in% c("eq_5d_3l_latent", "out") & grepl("^eq_5d_3l_[1-5]$", rhs))%>%
select(rhs, est.std, boot.ci.lower, boot.ci.upper, pvalue) %>%
mutate(pvalue = ifelse(pvalue < 0.001, "<0.001",
ifelse(pvalue < 0.01, sprintf("%.3f", pvalue),
sprintf("%.2f", pvalue)))) %>%
mutate(
est.std = round(est.std, 3),
boot.ci.lower = round(boot.ci.lower, 3),
boot.ci.upper = round(boot.ci.upper, 3)
)
factor_load_eq <- factor_load_eq %>%
mutate(rhs = case_when(
rhs == "eq_5d_3l_1" ~ "Mobility",
rhs == "eq_5d_3l_2" ~ "Self-care",
rhs == "eq_5d_3l_3" ~ "Usual activities",
rhs == "eq_5d_3l_4" ~ "Pain/discomfort",
rhs == "eq_5d_3l_5" ~ "Anxiety/depression",
TRUE ~ rhs
))
# Save
saveRDS(factor_load_eq, "data/attfbis_factor_load_2.RData")
saveRDS(S_coef_values, "data/attfbis_S_coef_2.RData")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
gt,
purrr,
extrafont)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load fonts
loadfonts()
# Combine
res1 <- readRDS("data/attfbis_table_multi_1.RData")
#
res <- as.data.frame(res1[,c(1,5,6,10)])
# Set col names
col_names <- as.character(unlist(res[1, ]))
res <- res[-1, ]
rownames(res) <- NULL
colnames(res) <- c("Characteristics",
"Unstandardized coefficient (95%CI)_1", "P value_1",
"Standardized coefficient (95%CI)_1")
#
process_missing_values <- function(...) {
row <- list(...)
for (i in 2:ncol(res)) {
if (is.na(row[[i]])) {
if (i > 1 && (is.na(row[[i-1]]) || row[[i-1]] == "")) {
row[[i]] <- ""
} else if (i > 1 && row[[i-1]] == "Ref") {
row[[i]] <- "—"
}
}
}
return(row)
}
#
res <- res %>%
mutate(across(everything(), as.character)) %>%
mutate(across(everything(), ~ ifelse(is.na(.x) | .x == "NA", "", .x))) %>%
pmap_dfr(process_missing_values) %>%
mutate(across(everything(), ~ ifelse(is.na(.x), "", .x)))
# Create your gt table
table <- res %>%
gt() %>%
sub_missing(
columns = 1:ncol(res),
missing_text = ""
) %>%
tab_style(
style = list(cell_text(weight = "bold")),
locations = cells_column_labels(everything())
) %>%
tab_spanner(
label = md("**<span style = 'color:black;'>SEM</span><sup>[1]</sup>**"),
columns = 2:4,
level = 1,
id = "sem_1"
) %>%
cols_label(
`Unstandardized coefficient (95%CI)_1` = md("Unstandardized coefficient (95%CI))"),
`P value_1` = md("*p*"),
`Standardized coefficient (95%CI)_1` = md("Standardized coefficient (95%CI)")
) %>%
cols_align(
align = "center",
columns = 2:ncol(res)
) %>%
cols_align(
align = "left",
columns = 1
) %>%
tab_style(
style = cell_text(align = "left", v_align = "middle"),
locations = cells_column_labels(columns = 1)
) %>%
tab_style(
style = cell_text(align = "center", v_align = "middle"),
locations = cells_column_labels(columns = 2:ncol(res))
) %>%
cols_width(
1 ~ px(190),
2 ~ px(160),
3 ~ px(50),
4 ~ px(150)
) %>%
tab_options(
column_labels.border.top.color = "black",
column_labels.border.top.width = px(2),
column_labels.border.bottom.color = "black",
column_labels.border.bottom.width = px(2),
table_body.hlines.color = "white",
table_body.hlines.width = px(0),
table.border.bottom.color = "white",
table.border.bottom.width = px(0),
data_row.padding = px(0),
source_notes.padding = px(0)
) %>%
tab_style(
style = cell_borders(
sides = "bottom",
color = "black",
weight = px(2)
),
locations = cells_body(
rows = nrow(res)
)
) %>%
tab_source_note(
source_note = "Note: [1] final model."
) %>%
tab_source_note(
source_note = "Abbreviations: SEM = Structural Equation Modeling, CI = Confidence Interval."
) %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_body(
rows = which(rowSums(is.na(res[, 2:ncol(res)]) | res[, 2:ncol(res)] == "", na.rm = TRUE) == ncol(res)-1),
columns = 1
)
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = list(
cells_title(groups = "title"),
cells_title(groups = "subtitle"),
cells_column_labels(),
cells_body()
)
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = cells_source_notes()
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10),
weight = "bold"
),
locations = cells_column_spanners(spanners = "sem_1")
)
print(table)
#
gtsave(data = table, filename = "output/table/table_analysis_sem.html")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
gt,
purrr,
extrafont)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load fonts
loadfonts()
# Combine
res1 <- readRDS("data/attfbis_table_multi_1.RData")
#
res <- as.data.frame(res1[,c(1,5,6,10)])
# Set col names
col_names <- as.character(unlist(res[1, ]))
res <- res[-1, ]
rownames(res) <- NULL
colnames(res) <- c("Characteristics",
"Unstandardized coefficient (95%CI)_1", "P value_1",
"Standardized coefficient (95%CI)_1")
#
process_missing_values <- function(...) {
row <- list(...)
for (i in 2:ncol(res)) {
if (is.na(row[[i]])) {
if (i > 1 && (is.na(row[[i-1]]) || row[[i-1]] == "")) {
row[[i]] <- ""
} else if (i > 1 && row[[i-1]] == "Ref") {
row[[i]] <- "—"
}
}
}
return(row)
}
#
res <- res %>%
mutate(across(everything(), as.character)) %>%
mutate(across(everything(), ~ ifelse(is.na(.x) | .x == "NA", "", .x))) %>%
pmap_dfr(process_missing_values) %>%
mutate(across(everything(), ~ ifelse(is.na(.x), "", .x)))
# Create your gt table
table <- res %>%
gt() %>%
sub_missing(
columns = 1:ncol(res),
missing_text = ""
) %>%
tab_style(
style = list(cell_text(weight = "bold")),
locations = cells_column_labels(everything())
) %>%
tab_spanner(
label = md("**<span style = 'color:black;'>SEM</span><sup>[1]</sup>**"),
columns = 2:4,
level = 1,
id = "sem_1"
) %>%
cols_label(
`Unstandardized coefficient (95%CI)_1` = md("Unstandardized coefficient (95%CI))"),
`P value_1` = md("*p*"),
`Standardized coefficient (95%CI)_1` = md("Standardized coefficient (95%CI)")
) %>%
cols_align(
align = "center",
columns = 2:ncol(res)
) %>%
cols_align(
align = "left",
columns = 1
) %>%
tab_style(
style = cell_text(align = "left", v_align = "middle"),
locations = cells_column_labels(columns = 1)
) %>%
tab_style(
style = cell_text(align = "center", v_align = "middle"),
locations = cells_column_labels(columns = 2:ncol(res))
) %>%
cols_width(
1 ~ px(190),
2 ~ px(160),
3 ~ px(50),
4 ~ px(150)
) %>%
tab_options(
column_labels.border.top.color = "black",
column_labels.border.top.width = px(2),
column_labels.border.bottom.color = "black",
column_labels.border.bottom.width = px(2),
table_body.hlines.color = "white",
table_body.hlines.width = px(0),
table.border.bottom.color = "white",
table.border.bottom.width = px(0),
data_row.padding = px(0),
source_notes.padding = px(0)
) %>%
tab_style(
style = cell_borders(
sides = "bottom",
color = "black",
weight = px(2)
),
locations = cells_body(
rows = nrow(res)
)
) %>%
tab_source_note(
source_note = "Note: [1] final model."
) %>%
tab_source_note(
source_note = "Abbreviations: ICU = Intensive Care Unit, HD = High Dependency, SEM = Structural Equation Modeling, CI = Confidence Interval."
) %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_body(
rows = which(rowSums(is.na(res[, 2:ncol(res)]) | res[, 2:ncol(res)] == "", na.rm = TRUE) == ncol(res)-1),
columns = 1
)
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = list(
cells_title(groups = "title"),
cells_title(groups = "subtitle"),
cells_column_labels(),
cells_body()
)
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = cells_source_notes()
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10),
weight = "bold"
),
locations = cells_column_spanners(spanners = "sem_1")
)
print(table)
#
gtsave(data = table, filename = "output/table/table_analysis_sem.html")
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 300) {
pdf_image <- image_read_pdf(input_pdf, density = dpi) # Read PDF with specified DPI
image_write(pdf_image, path = output_png, format = "png") # Write as PNG
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file) # Replace .pdf extension with .png
pdf_to_png(file, png_file)
}
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 1000) {
pdf_image <- image_read_pdf(input_pdf, density = dpi)
image_write(pdf_image, path = output_png, format = "png")
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file) # Replace .pdf extension with .png
pdf_to_png(file, png_file)
}
