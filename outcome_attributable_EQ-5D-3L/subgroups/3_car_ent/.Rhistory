patchwork,
Cairo)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load fonts
loadfonts()
# Data
factor_load <- readRDS("data/attfbis_factor_load_3_sub.RData")
S_coef <- readRDS("data/attfbis_S_coef_3_sub.RData")
# Preprocess and plot
plots_combined <- list()
for (i in seq_along(S_coef)) {
S_coef[[i]]$rhs <- factor(S_coef[[i]]$rhs, levels = rev(unique(S_coef[[i]]$rhs)))
# ---- Order factor_load by est.std (largest at the top) ----
ord_by_est <- factor_load[[i]] %>%
dplyr::arrange(est.std) %>%   # ascending: small → large
dplyr::pull(rhs)
factor_load[[i]] <- factor_load[[i]] %>%
dplyr::mutate(rhs = factor(rhs, levels = ord_by_est))
S_coef[[i]] <- S_coef[[i]] %>%
mutate(sig_label = case_when(
pvalue < 0.001 ~ "***",
pvalue < 0.01 ~ "**",
pvalue < 0.05 ~ "*",
TRUE ~ ""
))
tit <- list("VAP", "Hospital-acquired BSI", "Healthcare-associated BSI")
# Coef plot
p <- ggplot(S_coef[[i]], aes(y = rhs, x = est.std)) +
geom_col(width = 0.7, color = NA, fill = "steelblue") +
geom_errorbar(aes(xmin = boot.ci.lower, xmax = boot.ci.upper),
width = 0.2, color = "black") +
geom_text(aes(x = boot.ci.upper, label = paste0(pvalue, sig_label)),
hjust = -0.2, vjust = 0.5, size = 3,
color = "black", family = "Times New Roman") +
theme_minimal() +
scale_x_continuous(limits = c(-0.15, 0.5), breaks = seq(-0.15, 0.4, by = 0.1)) +
labs(x = ifelse(i == 3, "Strength of standardized effect", ""),
y = NULL, title = tit[[i]]) +
theme(
text = element_text(family = "Times New Roman", size = 10, color = "black"),
axis.text.y = element_text(size = 10, family = "Times New Roman", color = "black"),
axis.text.x = if (i == 3) element_text(size = 10, family = "Times New Roman",
color = "black") else element_blank(),
axis.title.x = element_text(size = 10, family = "Times New Roman", color = "black"),
plot.title = element_text(size = 10, color = "black",
family = "Times New Roman", hjust = 0.5),
legend.title = element_text(size = 10, color = "black"),
legend.text = element_text(size = 10, color = "black",
margin = margin(l = 3, r = 6, unit = "pt")),
legend.position = "bottom",
legend.direction = "horizontal",
legend.margin = margin(t = -5, r = 0, b = 0, l = 0)
)
# Factor loading plot
ann <- if (i == 1) {
annotate("text", x = "EQ-5D-3L", y = length(factor_load[[i]]$rhs) + 1.2,
label = "EQ-5D-3L", size = 3.2, family = "Times New Roman")
} else {
NULL
}
p2 <- ggplot(factor_load[[i]], aes(y = rhs, x = "EQ-5D-3L", fill = est.std)) +
geom_tile(color = "white") +
geom_text(aes(label = paste0(rhs, " (", sprintf("%.3f", est.std), ")")),
color = "white", size = 3.2, fontface = "bold", family = "Times New Roman") +
ann +
expand_limits(y = length(factor_load[[i]]$rhs) + 2) +
scale_fill_gradientn(colors = viridis_pal(option = "plasma", end = 0.9, direction = -1)(5),
name = "")  +
theme_minimal() +
labs(x = "", y = "", title = "") +
theme(
text = element_text(family = "Times New Roman", size = 10, color = "black"),
axis.text.y = element_blank(),
axis.text.x = element_blank(),
axis.title.x = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "none"
)
# Combine two plots
plots_combined[[i]] <- p + p2 + plot_layout(ncol = 2, widths = c(1, 0.6))
}
p <- wrap_plots(plots_combined, ncol = 1, heights = c(0.4, 0.5, 0.4))
# Save
CairoPDF("output/pdf/eq_3_sub.pdf", width = 9, height = 7)
print(p)
dev.off()
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
extrafont,
ggplot2,
scales,
patchwork,
Cairo)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load fonts
loadfonts()
# Data
factor_load <- readRDS("data/attfbis_factor_load_3_sub.RData")
S_coef <- readRDS("data/attfbis_S_coef_3_sub.RData")
# Preprocess and plot
plots_combined <- list()
for (i in seq_along(S_coef)) {
S_coef[[i]]$rhs <- factor(S_coef[[i]]$rhs, levels = rev(unique(S_coef[[i]]$rhs)))
# ---- Order factor_load by est.std (largest at the top) ----
ord_by_est <- factor_load[[i]] %>%
dplyr::arrange(est.std) %>%   # ascending: small → large
dplyr::pull(rhs)
factor_load[[i]] <- factor_load[[i]] %>%
dplyr::mutate(rhs = factor(rhs, levels = ord_by_est))
S_coef[[i]] <- S_coef[[i]] %>%
mutate(sig_label = case_when(
pvalue < 0.001 ~ "***",
pvalue < 0.01 ~ "**",
pvalue < 0.05 ~ "*",
TRUE ~ ""
))
tit <- list("VAP", "Hospital-acquired BSI", "Healthcare-associated BSI")
# Coef plot
p <- ggplot(S_coef[[i]], aes(y = rhs, x = est.std)) +
geom_col(width = 0.7, color = NA, fill = "steelblue") +
geom_errorbar(aes(xmin = boot.ci.lower, xmax = boot.ci.upper),
width = 0.2, color = "black") +
geom_text(aes(x = boot.ci.upper, label = paste0(pvalue, sig_label)),
hjust = -0.2, vjust = 0.5, size = 3,
color = "black", family = "Times New Roman") +
theme_minimal() +
scale_x_continuous(limits = c(-0.15, 0.5), breaks = seq(-0.15, 0.4, by = 0.1)) +
labs(x = ifelse(i == 3, "Strength of standardized effect", ""),
y = NULL, title = tit[[i]]) +
theme(
text = element_text(family = "Times New Roman", size = 10, color = "black"),
axis.text.y = element_text(size = 10, family = "Times New Roman", color = "black"),
axis.text.x = if (i == 3) element_text(size = 10, family = "Times New Roman",
color = "black") else element_blank(),
axis.title.x = element_text(size = 10, family = "Times New Roman", color = "black"),
plot.title = element_text(size = 10, color = "black",
family = "Times New Roman", hjust = 0.5),
legend.title = element_text(size = 10, color = "black"),
legend.text = element_text(size = 10, color = "black",
margin = margin(l = 3, r = 6, unit = "pt")),
legend.position = "bottom",
legend.direction = "horizontal",
legend.margin = margin(t = -5, r = 0, b = 0, l = 0)
)
# Factor loading plot
ann <- if (i == 1) {
annotate("text", x = "EQ-5D-3L", y = length(factor_load[[i]]$rhs) + 1.2,
label = "EQ-5D-3L", size = 3.2, family = "Times New Roman")
} else {
NULL
}
p2 <- ggplot(factor_load[[i]], aes(y = rhs, x = "EQ-5D-3L", fill = est.std)) +
geom_tile(color = "white") +
geom_text(aes(label = paste0(rhs, " (", sprintf("%.3f", est.std), ")")),
color = "white", size = 3.2, fontface = "bold", family = "Times New Roman") +
ann +
expand_limits(y = length(factor_load[[i]]$rhs) + 2) +
scale_fill_gradientn(colors = viridis_pal(option = "plasma", end = 0.9, direction = -1)(5),
name = "")  +
theme_minimal() +
labs(x = "", y = "", title = "") +
theme(
text = element_text(family = "Times New Roman", size = 10, color = "black"),
axis.text.y = element_blank(),
axis.text.x = element_blank(),
axis.title.x = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "none"
)
# Combine two plots
plots_combined[[i]] <- p + p2 + plot_layout(ncol = 2, widths = c(1, 0.6))
}
p <- wrap_plots(plots_combined, ncol = 1, heights = c(0.3, 0.5, 0.3))
# Save
CairoPDF("output/pdf/eq_3_sub.pdf", width = 9, height = 7)
print(p)
dev.off()
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
fastDummies,
semhelpinghands,
lavaan)
})
# Define directory
wd <- "./"
setwd(wd)
# Load data
df_all <- readRDS("data/att_eq.RData")
df_all <- as.data.frame(df_all[[3]])
# Split by infection types
df_used <- split(df_all, df_all$infection_types)
#
result_save <- S_coef_values_all <- factor_load_eq_all <- list()
for (i in 1:3){
df <- df_used[[i]]
# Ensure `ent_car` is numeric
df$ent_car <- ifelse(grepl("resistant$", df$ent_car), 1, 0)
# Define SEM model
if (i == 1) {
sem_model <- '
# 1. Define latent variable eq_5d_3l_latent
eq_5d_3l_latent =~ eq_5d_3l_1 + eq_5d_3l_4 + eq_5d_3l_5
out =~ eq_5d_3l_2 + eq_5d_3l_3
# 2. Structural equation model, delete comorbidities_CCI + severity_score_scale + icu_hd_ap + pathogen_combined_types
eq_5d_3l_latent ~ age_new + sex + ent_car
out ~ eq_5d_3l_latent
'
} else if (i == 2) {
sem_model <- '
# 1. Define latent variable eq_5d_3l_latent
eq_5d_3l_latent =~ eq_5d_3l_1 + eq_5d_3l_4 + eq_5d_3l_5
out =~ eq_5d_3l_2 + eq_5d_3l_3
# 2. Structural equation model
eq_5d_3l_latent ~ age_new + sex + comorbidities_CCI + severity_score_scale + icu_hd_ap + pathogen_combined_types + ent_car
out ~ eq_5d_3l_latent
'
} else if (i == 3) {
sem_model <- '
# 1. Define latent variable eq_5d_3l_latent
eq_5d_3l_latent =~ eq_5d_3l_1 + eq_5d_3l_4 + eq_5d_3l_5
out =~ eq_5d_3l_2 + eq_5d_3l_3
# 2. Structural equation model, delete comorbidities_CCI + severity_score_scale + icu_hd_ap + pathogen_combined_types
eq_5d_3l_latent ~ age_new + sex + ent_car
out ~ eq_5d_3l_latent
'
}
# Run SEM
fit <- sem(sem_model, data = df, se = "bootstrap", bootstrap = 1000)
# CI
ci_boot <- standardizedSolution_boot_ci(fit)
param_est <- parameterEstimates(fit, standardized = TRUE, ci = TRUE)
# Coef
important_vars <- c("age_new", "sex", "comorbidities_CCI", "severity_score_scale", "icu_hd_ap", "pathogen_combined_types", "ent_car")
S_coef_values <- ci_boot %>%
filter(lhs == "eq_5d_3l_latent" & rhs %in% important_vars)%>%
select(rhs, est.std, boot.ci.lower, boot.ci.upper, pvalue) %>%
mutate(pvalue = ifelse(pvalue < 0.001, "<0.001",
ifelse(pvalue < 0.01, sprintf("%.3f", pvalue),
sprintf("%.2f", pvalue)))) %>%
mutate(
est.std = round(est.std, 2),
boot.ci.lower = round(boot.ci.lower, 2),
boot.ci.upper = round(boot.ci.upper, 2)
) %>%
mutate(`S_coef (95%CI)` = paste0(est.std, " [", boot.ci.lower, ", ", boot.ci.upper, "]"))
U_coef_values <- param_est %>%
filter(lhs == "eq_5d_3l_latent" & rhs %in% important_vars) %>%
select(rhs, est, ci.lower, ci.upper, pvalue) %>%
mutate(pvalue = ifelse(pvalue < 0.001, "<0.001",
ifelse(pvalue < 0.01, sprintf("%.3f", pvalue),
sprintf("%.2f", pvalue))))%>%
mutate(
est = round(est, 2),
ci.lower = round(ci.lower, 2),
ci.upper = round(ci.upper, 2)
) %>%
mutate(`coef (95%CI)` = paste0(est, " [", ci.lower, ", ", ci.upper, "]"))
coef_df <- left_join(U_coef_values, S_coef_values[,-5], by = "rhs")
# Factor load
factor_load_eq <- ci_boot %>%
filter(lhs %in% c("eq_5d_3l_latent", "out") & grepl("^eq_5d_3l_[1-5]$", rhs))%>%
select(rhs, est.std, boot.ci.lower, boot.ci.upper, pvalue) %>%
mutate(pvalue = ifelse(pvalue < 0.001, "<0.001",
ifelse(pvalue < 0.01, sprintf("%.3f", pvalue),
sprintf("%.2f", pvalue)))) %>%
mutate(
est.std = round(est.std, 3),
boot.ci.lower = round(boot.ci.lower, 3),
boot.ci.upper = round(boot.ci.upper, 3)
)
#
if (i == 1){
rows <- list(
c("Characteristics", NA, NA, NA, "Unstandardized coefficient (95%CI)", "p.value", NA, NA, NA, "Standardized coefficient (95%CI)"),
c("Age", rep(NA,9)),
c(NA, coef_df[1, c(2:4, 6, 5, 7:10)]),
c("Sex", rep(NA,9)),
c("Female", NA, NA, NA, "Ref", rep(NA,5)),
c("Male", coef_df[2, c(2:4, 6, 5, 7:10)]),
c("Charlson comorbidity index", rep(NA,9)),
c(NA, rep(NA,9)),
c("Severity score of disease", rep(NA,9)),
c(NA, rep(NA,9)),
c("Admission to ICU/HD at enrollment", rep(NA,9)),
c("No", rep(NA,9)),
c("Yes", rep(NA,9)),
c("Type of pathogens", rep(NA,9)),
c("Monomicrobial", rep(NA,9)),
c("Polymicrobial", rep(NA,9)),
c("Enterobacterales", rep(NA,9)),
c("Carbapenem-susceptible", NA, NA, NA, "Ref", rep(NA,5)),
c("Carbapenem-resistant", coef_df[3, c(2:4, 6, 5, 7:10)]))
} else if (i == 2) {
rows <- list(
c("Characteristics", NA, NA, NA, "Unstandardized coefficient (95%CI)", "p.value", NA, NA, NA, "Standardized coefficient (95%CI)"),
c("Age", rep(NA,9)),
c(NA, coef_df[1, c(2:4, 6, 5, 7:10)]),
c("Sex", rep(NA,9)),
c("Female", NA, NA, NA, "Ref", rep(NA,5)),
c("Male", coef_df[2, c(2:4, 6, 5, 7:10)]),
c("Charlson comorbidity index", rep(NA,9)),
c(NA, coef_df[3, c(2:4, 6, 5, 7:10)]),
c("Severity score of disease", rep(NA,9)),
c(NA, coef_df[4, c(2:4, 6, 5, 7:10)]),
c("Admission to ICU/HD at enrollment", rep(NA,9)),
c("No", NA, NA, NA, "Ref", rep(NA,5)),
c("Yes", coef_df[5, c(2:4, 6, 5, 7:10)]),
c("Type of pathogens", rep(NA,9)),
c("Monomicrobial",  NA, NA, NA, "Ref", rep(NA,5)),
c("Polymicrobial", coef_df[6, c(2:4, 6, 5, 7:10)]),
c("Enterobacterales", rep(NA,9)),
c("Carbapenem-susceptible", NA, NA, NA, "Ref", rep(NA,5)),
c("Carbapenem-resistant", coef_df[7, c(2:4, 6, 5, 7:10)]))
} else if (i == 3){
rows <- list(
c("Characteristics", NA, NA, NA, "Unstandardized coefficient (95%CI)", "p.value", NA, NA, NA, "Standardized coefficient (95%CI)"),
c("Age", rep(NA,9)),
c(NA, coef_df[1, c(2:4, 6, 5, 7:10)]),
c("Sex", rep(NA,9)),
c("Female", NA, NA, NA, "Ref", rep(NA,5)),
c("Male", coef_df[2, c(2:4, 6, 5, 7:10)]),
c("Charlson comorbidity index", rep(NA,9)),
c(NA, rep(NA,9)),
c("Severity score of disease", rep(NA,9)),
c(NA, rep(NA,9)),
c("Admission to ICU/HD at enrollment", rep(NA,9)),
c("No", rep(NA,9)),
c("Yes", rep(NA,9)),
c("Type of pathogens", rep(NA,9)),
c("Monomicrobial", rep(NA,9)),
c("Polymicrobial", rep(NA,9)),
c("Enterobacterales", rep(NA,9)),
c("Carbapenem-susceptible", NA, NA, NA, "Ref", rep(NA,5)),
c("Carbapenem-resistant", coef_df[3, c(2:4, 6, 5, 7:10)]))
}
# Bind the rows into a matrix
result <- do.call(rbind, rows)
#
result <- as.data.frame(result)
result[, c(5:6, 10)] <- lapply(result[, c(5:6, 10)], as.character)
result[, c(2:4, 7:9)] <- lapply(result[, c(2:4, 7:9)], as.numeric)
result_save[[i]] <- result
#
# Rename
S_coef_values <- S_coef_values %>%
mutate(rhs = case_when(
rhs == "age_new" ~ "Age (years)",
rhs == "sex" ~ "Male (vs female)",
rhs == "comorbidities_CCI" ~ "Charlson comorbidity index",
rhs == "severity_score_scale" ~ "Severity score of disease",
rhs == "icu_hd_ap" ~ "Admission to ICU/HD at enrollment (yes vs no)",
rhs == "pathogen_combined_types" ~ "Polymicrobial (vs monomicrobial)",
rhs == "ent_car" ~ "CRE (vs CSE)",
TRUE ~ rhs
))
factor_load_eq <- factor_load_eq %>%
mutate(rhs = case_when(
rhs == "eq_5d_3l_1" ~ "Mobility",
rhs == "eq_5d_3l_2" ~ "Self-care",
rhs == "eq_5d_3l_3" ~ "Usual activities",
rhs == "eq_5d_3l_4" ~ "Pain/discomfort",
rhs == "eq_5d_3l_5" ~ "Anxiety/depression",
TRUE ~ rhs
))
S_coef_values_all[[i]] <- S_coef_values
factor_load_eq_all[[i]] <- factor_load_eq
}
# Save
saveRDS(result_save, "data/attfbis_table_multi_3_sub.RData")
saveRDS(factor_load_eq_all, "data/attfbis_factor_load_3_sub.RData")
saveRDS(S_coef_values_all, "data/attfbis_S_coef_3_sub.RData")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
extrafont,
ggplot2,
scales,
patchwork,
Cairo)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load fonts
loadfonts()
# Data
factor_load <- readRDS("data/attfbis_factor_load_3_sub.RData")
S_coef <- readRDS("data/attfbis_S_coef_3_sub.RData")
# Preprocess and plot
plots_combined <- list()
for (i in seq_along(S_coef)) {
S_coef[[i]]$rhs <- factor(S_coef[[i]]$rhs, levels = rev(unique(S_coef[[i]]$rhs)))
# ---- Order factor_load by est.std (largest at the top) ----
ord_by_est <- factor_load[[i]] %>%
dplyr::arrange(est.std) %>%   # ascending: small → large
dplyr::pull(rhs)
factor_load[[i]] <- factor_load[[i]] %>%
dplyr::mutate(rhs = factor(rhs, levels = ord_by_est))
S_coef[[i]] <- S_coef[[i]] %>%
mutate(sig_label = case_when(
pvalue < 0.001 ~ "***",
pvalue < 0.01 ~ "**",
pvalue < 0.05 ~ "*",
TRUE ~ ""
))
tit <- list("VAP", "Hospital-acquired BSI", "Healthcare-associated BSI")
# Coef plot
p <- ggplot(S_coef[[i]], aes(y = rhs, x = est.std)) +
geom_col(width = 0.7, color = NA, fill = "steelblue") +
geom_errorbar(aes(xmin = boot.ci.lower, xmax = boot.ci.upper),
width = 0.2, color = "black") +
geom_text(aes(x = boot.ci.upper, label = paste0(pvalue, sig_label)),
hjust = -0.2, vjust = 0.5, size = 3,
color = "black", family = "Times New Roman") +
theme_minimal() +
scale_x_continuous(limits = c(-0.15, 0.5), breaks = seq(-0.15, 0.4, by = 0.1)) +
labs(x = ifelse(i == 3, "Strength of standardized effect", ""),
y = NULL, title = tit[[i]]) +
theme(
text = element_text(family = "Times New Roman", size = 10, color = "black"),
axis.text.y = element_text(size = 10, family = "Times New Roman", color = "black"),
axis.text.x = if (i == 3) element_text(size = 10, family = "Times New Roman",
color = "black") else element_blank(),
axis.title.x = element_text(size = 10, family = "Times New Roman", color = "black"),
plot.title = element_text(size = 10, color = "black",
family = "Times New Roman", hjust = 0.5),
legend.title = element_text(size = 10, color = "black"),
legend.text = element_text(size = 10, color = "black",
margin = margin(l = 3, r = 6, unit = "pt")),
legend.position = "bottom",
legend.direction = "horizontal",
legend.margin = margin(t = -5, r = 0, b = 0, l = 0)
)
# Factor loading plot
ann <- if (i == 1) {
annotate("text", x = "EQ-5D-3L", y = length(factor_load[[i]]$rhs) + 1.2,
label = "EQ-5D-3L", size = 3.2, family = "Times New Roman")
} else {
NULL
}
p2 <- ggplot(factor_load[[i]], aes(y = rhs, x = "EQ-5D-3L", fill = est.std)) +
geom_tile(color = "white") +
geom_text(aes(label = paste0(rhs, " (", sprintf("%.3f", est.std), ")")),
color = "white", size = 3.2, fontface = "bold", family = "Times New Roman") +
ann +
expand_limits(y = length(factor_load[[i]]$rhs) + 2) +
scale_fill_gradientn(colors = viridis_pal(option = "plasma", end = 0.9, direction = -1)(5),
name = "")  +
theme_minimal() +
labs(x = "", y = "", title = "") +
theme(
text = element_text(family = "Times New Roman", size = 10, color = "black"),
axis.text.y = element_blank(),
axis.text.x = element_blank(),
axis.title.x = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "none"
)
# Combine two plots
plots_combined[[i]] <- p + p2 + plot_layout(ncol = 2, widths = c(1, 0.6))
}
p <- wrap_plots(plots_combined, ncol = 1, heights = c(0.3, 0.5, 0.3))
# Save
CairoPDF("output/pdf/eq_3_sub.pdf", width = 9, height = 7)
print(p)
dev.off()
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 1000) {
pdf_image <- image_read_pdf(input_pdf, density = dpi)
image_write(pdf_image, path = output_png, format = "png")
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file)
pdf_to_png(file, png_file)
}
