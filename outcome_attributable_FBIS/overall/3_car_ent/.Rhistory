result[, 2:4] <- lapply(result[, 2:4], as.numeric)
result_save <- result[, c(1, 5, 6)]
# Save
saveRDS(result_save, "data/attfbis_table_univariable_overall.RData")
###
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
MASS)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
df_all <- readRDS("data/att_fbis.RData")
# Enterobacterales, carbapenem-resistant
df <- as.data.frame(df_all[[3]])
#
df$fbis_score <- factor(df$fbis_score, ordered = TRUE)
# Model, delete comorbidities_CCI
formula <- fbis_score ~
age_new + sex + country_region + country_income +
hpd_admreason + severity_score_scale + icu_hd_ap +
pathogen_combined_types +
ent_car
model <- MASS::polr(formula, data = df, method = "logistic", Hess = TRUE)
# Summarize model
model_summary <- summary(model)
p_model <- data.frame(model_summary$coefficients)
p_model$values <- p_model$Value
p_model$se_values <- p_model$Std..Error
p_model$t_values <- p_model$t.value
p_model$upper_ci <- p_model$values + 1.96 * p_model$se_values
p_model$lower_ci <- p_model$values - 1.96 * p_model$se_values
p_values_for_var <- 2 * (1 - pnorm(abs(p_model$t_values)))
p_model$p.value <- ifelse(p_values_for_var < 0.001, "<0.001",
ifelse(p_values_for_var < 0.01, sprintf("%.3f", p_values_for_var),
sprintf("%.2f", p_values_for_var)))
# Delete rows
del_row <- grepl("\\|", rownames(p_model))
p_model <- p_model[!del_row, ]
# Coef
coef_df <- transform(p_model,
Coef = sprintf("%.2f", values),
Lower_CI = sprintf("%.2f", lower_ci),
Upper_CI = sprintf("%.2f", upper_ci))
coef_df$`coef (95%CI)` = paste0(coef_df$Coef, " [", coef_df$Lower_CI, ", ", coef_df$Upper_CI, "]", sep = "")
rows <- list(
c("Characteristics", NA, NA, NA, "Adjusted coefficient (95%CI)", "p.value"),
c("Age", NA, NA, NA, NA, NA),
c(NA, coef_df[1, c(10:13, 9)]),
c("Sex", NA, NA, NA, NA, NA),
c("Female", NA, NA, NA, "Ref", NA),
c("Male", coef_df[2, c(10:13, 9)]),
c("Region", NA, NA, NA, NA, NA),
c("Eastern Mediterranean Region", NA, NA, NA, "Ref", NA),
c("South-East Asian Region", coef_df[3, c(10:13, 9)]),
c("Western Pacific Region", coef_df[4, c(10:13, 9)]),
c("World Bank income status", NA, NA, NA, NA, NA),
c("High income", NA, NA, NA, "Ref", NA),
c("Upper middle income", coef_df[5, c(10:13, 9)]),
c("Lower middle income", coef_df[6, c(10:13, 9)]),
c("Primary admission reason", NA, NA, NA, NA, NA),
c("Infectious disease", NA, NA, NA, "Ref", NA),
c("Gastrointestinal disorder", coef_df[7, c(10:13, 9)]),
c("Pulmonary disease", coef_df[8, c(10:13, 9)]),
c("Others", coef_df[9, c(10:13, 9)]),
c("Charlson comorbidity index", NA, NA, NA, NA, NA),
c(NA, NA, NA, NA, NA, NA),
c("Severity score of disease", NA, NA, NA, NA, NA),
c(NA, coef_df[10, c(10:13, 9)]),
c("Admission to ICU/HD at enrollment", NA, NA, NA, NA, NA),
c("No", NA, NA, NA, "Ref", NA),
c("Yes", coef_df[11, c(10:13, 9)]),
c("Type of pathogens", NA, NA, NA, NA, NA),
c("Monomicrobial", NA, NA, NA, "Ref", NA),
c("Polymicrobial",coef_df[12, c(10:13, 9)]),
c("Enterobacterales", NA, NA, NA, NA, NA),
c("Carbapenem-susceptible", NA, NA, NA, "Ref", NA),
c("Carbapenem-resistant", coef_df[13, c(10:13, 9)]))
# Bind the rows into a matrix
result <- do.call(rbind, rows) %>%
as.data.frame()
result[, 5:6] <- lapply(result[, 5:6], as.character)
result[, 2:4] <- lapply(result[, 2:4], as.numeric)
result_save <- result[, c(1, 5, 6)]
# Save table
saveRDS(result_save, "data/attfbis_table_multi_1_overall.RData")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
gt,
purrr,
extrafont)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load fonts
loadfonts()
# Combine
res1 <- readRDS("data/attfbis_table_univariable_overall.RData")
res2 <- readRDS("data/attfbis_table_multi_1_overall.RData")
#
res <- cbind.data.frame(res1, res2[,c(2,3)])
# Set col names
col_names <- as.character(unlist(res[1, ]))
res <- res[-1, ]
rownames(res) <- NULL
colnames(res) <- c("Characteristics",
"Crude coefficient (95%CI)_uni", "P value_uni",
"Adjusted coefficient (95%CI)_multi_1", "P value_multi_1")
#
process_missing_values <- function(...) {
row <- list(...)
for (i in 2:ncol(res)) {
if (is.na(row[[i]])) {
if (i > 1 && (is.na(row[[i-1]]) || row[[i-1]] == "")) {
row[[i]] <- ""
} else if (i > 1 && row[[i-1]] == "Ref") {
row[[i]] <- "â€”"
}
}
}
return(row)
}
#
res <- res %>%
mutate(across(everything(), ~ ifelse(.x == "NA", "", .x)))%>%
mutate(across(everything(), as.character)) %>%
pmap_dfr(process_missing_values)
# Create table
table <- res %>%
gt() %>%
sub_missing(
columns = 1:ncol(res),
missing_text = ""
) %>%
tab_style(
style = list(cell_text(weight = "bold")),
locations = cells_column_labels(everything())
) %>%
tab_spanner(
label = md("**<span style = 'color:black;'>Univariable analysis</span><sup> </sup>**"),
columns = 2:3
) %>%
tab_spanner(
label = md("**<span style = 'color:black;'>Multivariable analysis</span><sup>[1]</sup>**"),
columns = 4:5
) %>%
cols_label(
`Crude coefficient (95%CI)_uni` = md("Crude coefficient (95%CI)"),
`P value_uni` = md("*p*"),
`Adjusted coefficient (95%CI)_multi_1` = md("Adjusted coefficient (95%CI)"),
`P value_multi_1` = md("*p*")
) %>%
cols_align(
align = "center",
columns = 2:ncol(res)
) %>%
cols_align(
align = "left",
columns = 1
) %>%
tab_style(
style = cell_text(align = "left", v_align = "middle"),
locations = cells_column_labels(columns = 1)
) %>%
cols_width(
1 ~ px(165),
2 ~ px(130),
3 ~ px(60),
4 ~ px(150),
5 ~ px(60)
) %>%
tab_options(
column_labels.border.top.color = "black",
column_labels.border.top.width = px(2),
column_labels.border.bottom.color = "black",
column_labels.border.bottom.width = px(2),
table_body.hlines.color = "white",
table_body.hlines.width = px(0),
table.border.bottom.color = "white",
table.border.bottom.width = px(0),
data_row.padding = px(0),
source_notes.padding = px(0)
) %>%
tab_style(
style = cell_borders(
sides = "bottom",
color = "black",
weight = px(2)
),
locations = cells_body(
rows = nrow(res)
)
) %>%
tab_source_note(
source_note = "Note: [1] final model."
) %>%
tab_source_note(
source_note = "Abbreviations: VAP = Ventilator-Associated Pneumonia, BSI = Bloodstream Infection, ICU = Intensive Care Unit, HD = High Dependency, CI = Confidence Interval."
) %>%
tab_style(
style = cell_text(weight = "bold"),
locations = cells_body(
rows = which(rowSums(is.na(res[, 2:ncol(res)]) | res[, 2:ncol(res)] == "",
na.rm = TRUE) == ncol(res)-1),
columns = 1
)
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = list(
cells_title(groups = "title"),
cells_title(groups = "subtitle"),
cells_column_labels(),
cells_body()
)
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10)
),
locations = cells_source_notes()
) %>%
tab_style(
style = cell_text(
font = "Times New Roman",
size = px(10),
weight = "bold"
),
locations = cells_column_spanners(spanners = tidyselect::matches("analysis"))
)
print(table)
# Save
gtsave(data = table, filename = "output/table/table_analysis_overall_3.html")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
MASS)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
df_all <- readRDS("data/att_fbis.RData")
# Enterobacterales, carbapenem-resistant
df <- as.data.frame(df_all[[3]])
# CI
bootstrap_prob_per_obs <- function(df_input, formula, var_name, n_boot = 500) {
if(!is.ordered(df_input$fbis_score)){
df_input$fbis_score <- factor(df_input$fbis_score, ordered = TRUE)
}
n_obs <- nrow(df_input)
score_levels <- levels(df_input$fbis_score)
K <- length(score_levels)
prob_array <- array(
NA,
dim = c(n_obs, K, n_boot),
dimnames = list(NULL, score_levels, NULL)
)
# Model
for (b in seq_len(n_boot)) {
boot_sample <- df_input[sample(n_obs, replace = TRUE), ]
if (length(unique(boot_sample$fbis_score)) < K) next
boot_model <- try(
MASS::polr(formula, data = boot_sample, method = "logistic", Hess = TRUE),
silent = TRUE
)
if (inherits(boot_model, "try-error")) next
#
pred_probs <- try(
predict(boot_model, newdata = df_input, type = "probs"),
silent = TRUE
)
if (inherits(pred_probs, "try-error")) next
#
prob_array[, , b] <- pred_probs
}
#
valid_boots <- which(!is.na(prob_array[1, 1, ]))
cat("Successful bootstraps:", length(valid_boots), "of", n_boot, "\n")
# Save
results_list <- vector("list", K)
for (k in seq_len(K)) {
probs_k <- prob_array[, k, valid_boots, drop = FALSE]
df_k <- data.frame(
recordid    = df_input$recordid,
obs_id      = seq_len(n_obs),
score_level = score_levels[k],
mean_prob   = rowMeans(probs_k, na.rm = TRUE),
lower_ci    = apply(probs_k, 1, quantile, probs = 0.025, na.rm = TRUE),
upper_ci    = apply(probs_k, 1, quantile, probs = 0.975, na.rm = TRUE)
)
#
df_k[[var_name]] <- df_input[[var_name]]
results_list[[k]] <- df_k
}
final_result <- do.call(rbind, results_list)
rownames(final_result) <- NULL
return(final_result)
}
# Result
set.seed(123)
# Y as ordinal
df$fbis_score <- factor(df$fbis_score, ordered = TRUE)
# Model
formula <- fbis_score ~
age_new + sex + country_region + country_income +
hpd_admreason + severity_score_scale + icu_hd_ap +
pathogen_combined_types +
ent_car
#
df_result <- bootstrap_prob_per_obs(
df_input = df,
formula  = formula,
var_name = "ent_car",
n_boot   = 1000
)
# Mean by score_level
prob_summary <- function(df_subset, group_label) {
df_subset %>%
group_by(score_level) %>%
summarise(
mean_prob = mean(mean_prob, na.rm = TRUE),
lower_ci  = mean(lower_ci, na.rm = TRUE),
upper_ci  = mean(upper_ci, na.rm = TRUE)
) %>%
mutate(
fbis_score = as.numeric(score_level),
group      = group_label
) %>%
dplyr::select(fbis_score, mean_prob, lower_ci, upper_ci, group)
}
#
df_plot <- rbind(
prob_summary(
df_result[grepl("susceptible$", df_result$ent_car), ],
"Carbapenem-susceptible"
),
prob_summary(
df_result[grepl("resistant$", df_result$ent_car), ],
"Carbapenem-resistant"
)
)
# Save data
saveRDS(df_plot, "data/data_plot_3.RData")
###
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
MASS,
ggplot2,
patchwork,
Cairo)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
df_all <- readRDS("3_car_ent/data/att_fbis.RData")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
MASS)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
df_all <- readRDS("data/att_fbis.RData")
# Enterobacterales, carbapenem-resistant
df <- as.data.frame(df_all[[3]])
# CI
bootstrap_prob_per_obs <- function(df_input, formula, var_name, n_boot = 500) {
if(!is.ordered(df_input$fbis_score)){
df_input$fbis_score <- factor(df_input$fbis_score, ordered = TRUE)
}
n_obs <- nrow(df_input)
score_levels <- levels(df_input$fbis_score)
K <- length(score_levels)
prob_array <- array(
NA,
dim = c(n_obs, K, n_boot),
dimnames = list(NULL, score_levels, NULL)
)
# Model
for (b in seq_len(n_boot)) {
boot_sample <- df_input[sample(n_obs, replace = TRUE), ]
if (length(unique(boot_sample$fbis_score)) < K) next
boot_model <- try(
MASS::polr(formula, data = boot_sample, method = "logistic", Hess = TRUE),
silent = TRUE
)
if (inherits(boot_model, "try-error")) next
#
pred_probs <- try(
predict(boot_model, newdata = df_input, type = "probs"),
silent = TRUE
)
if (inherits(pred_probs, "try-error")) next
#
prob_array[, , b] <- pred_probs
}
#
valid_boots <- which(!is.na(prob_array[1, 1, ]))
cat("Successful bootstraps:", length(valid_boots), "of", n_boot, "\n")
# Save
results_list <- vector("list", K)
for (k in seq_len(K)) {
probs_k <- prob_array[, k, valid_boots, drop = FALSE]
df_k <- data.frame(
recordid    = df_input$recordid,
obs_id      = seq_len(n_obs),
score_level = score_levels[k],
mean_prob   = rowMeans(probs_k, na.rm = TRUE),
lower_ci    = apply(probs_k, 1, quantile, probs = 0.025, na.rm = TRUE),
upper_ci    = apply(probs_k, 1, quantile, probs = 0.975, na.rm = TRUE)
)
#
df_k[[var_name]] <- df_input[[var_name]]
results_list[[k]] <- df_k
}
final_result <- do.call(rbind, results_list)
rownames(final_result) <- NULL
return(final_result)
}
# Result
set.seed(123)
# Y as ordinal
df$fbis_score <- factor(df$fbis_score, ordered = TRUE)
# Model
formula <- fbis_score ~
age_new + sex + country_region + country_income +
hpd_admreason + severity_score_scale + icu_hd_ap +
pathogen_combined_types +
ent_car
#
df_result <- bootstrap_prob_per_obs(
df_input = df,
formula  = formula,
var_name = "ent_car",
n_boot   = 1000
)
# Mean by score_level
prob_summary <- function(df_subset, group_label) {
df_subset %>%
group_by(score_level) %>%
summarise(
mean_prob = mean(mean_prob, na.rm = TRUE),
lower_ci  = mean(lower_ci, na.rm = TRUE),
upper_ci  = mean(upper_ci, na.rm = TRUE)
) %>%
mutate(
fbis_score = as.numeric(score_level),
group      = group_label
) %>%
dplyr::select(fbis_score, mean_prob, lower_ci, upper_ci, group)
}
#
df_plot <- rbind(
prob_summary(
df_result[grepl("susceptible$", df_result$ent_car), ],
"Carbapenem-susceptible"
),
prob_summary(
df_result[grepl("resistant$", df_result$ent_car), ],
"Carbapenem-resistant"
)
)
# N total
N_group <- df_result %>%
group_by(ent_car) %>%
summarise(N = n_distinct(recordid)) %>%
mutate(group = ifelse(
grepl("susceptible$", ent_car),
"Carbapenem-susceptible",
"Carbapenem-resistant"
)) %>%
dplyr::select(group, N)
df_expected_count <- df_plot %>%
left_join(N_group, by = "group") %>%
mutate(
expected_count = round(mean_prob * N, 0),
) %>%
dplyr::select(fbis_score, expected_count, group)
print(df_expected_count)
# Save data
saveRDS(df_plot, "data/data_plot_3.RData")
saveRDS(df_expected_count, "data/df_count_3.RData")
###
