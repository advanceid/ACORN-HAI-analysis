PAF_eff_hi  = ifelse(use_overall, PAF_overall_hi_OVR, PAF_overall_hi),
attrib_deaths_est = deaths_est  * PAF_eff,
attrib_deaths_lo  = deaths_low  * PAF_eff_lo,
attrib_deaths_hi  = deaths_high * PAF_eff_hi
) %>%
arrange(
match(income_level, c("Overall","High income","Upper middle income","Lower middle income","Low income")),
match(pathogen, pathogens)
)
# Clean table output
table_clean <- death_attr_income %>%
mutate(
Deaths          = fmt_ci_number(deaths_est, deaths_low, deaths_high, digits = 0),
PAF_overall_fmt = fmt_ci_percent_mix(PAF_eff, PAF_eff_lo, PAF_eff_hi, digits = 2),
Attrib_deaths   = fmt_ci_number(attrib_deaths_est, attrib_deaths_lo, attrib_deaths_hi, digits = 0),
income_level    = factor(income_level,
levels = c("Overall","High income","Upper middle income","Lower middle income","Low income")),
pathogen        = factor(pathogen, levels = pathogens)
) %>%
arrange(income_level, pathogen) %>%
select(
income_level, pathogen,
Deaths,
PAF_overall = PAF_overall_fmt,
Attrib_deaths
)
print(table_clean)
# =========================
# Plot (include High income and Low income)
# =========================
keep_income  <- c("Overall","High income","Upper middle income","Lower middle income","Low income")
keep_patho   <- c("amr","mdr","mdr_gnb")   # order in data
patho_labels <- c(amr = "AMR", mdr = "MDR", mdr_gnb = "MDR-GNB")
df_plot <- death_attr_income %>%
filter(income_level %in% keep_income,
pathogen %in% keep_patho) %>%
transmute(
income_level = factor(income_level, levels = keep_income),
pathogen     = factor(pathogen, levels = keep_patho, labels = patho_labels[keep_patho]),
est = attrib_deaths_est,
lo  = attrib_deaths_lo,
hi  = attrib_deaths_hi
) %>%
mutate(
est_m = est / 1e6,
lo_m  = lo  / 1e6,
hi_m  = hi  / 1e6
)
# Colors (must match factor levels "AMR","MDR","MDR-GNB")
patho_colors <- c(
"AMR"     = "#8F9AE6",
"MDR"     = "#F3A85C",
"MDR-GNB" = "#4EB3A5"
)
pd <- position_dodge(width = 0.75)
p <- ggplot(df_plot, aes(x = income_level, y = est_m, fill = pathogen)) +
geom_col(position = pd, width = 0.7) +
geom_errorbar(aes(ymin = lo_m, ymax = hi_m),
position = pd, width = 0.15, linewidth = 0.6, color = "black") +
scale_fill_manual(values = patho_colors, name = NULL) +
scale_y_continuous(
name = "Attributable deaths (million)",
expand = expansion(mult = c(0.02, 0.06))
) +
xlab(NULL) +
theme_minimal(base_size = 10, base_family = "Times New Roman") +
theme(
legend.position = "top",
legend.text = element_text(color = "black"),
axis.text   = element_text(color = "black"),
axis.title  = element_text(color = "black"),
axis.line   = element_line(color = "black"),
axis.ticks  = element_line(color = "black"),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank()
)
print(p)
# Save
ggsave("output/pdf/attrib_deaths_all_income.pdf", p, width = 6.5, height = 4, device = cairo_pdf)
# Clear & packages
rm(list = ls())
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(
dplyr, magrittr, tidyr, purrr, tibble, gt,
survival, coxphw, ggplot2, scales
)
})
# Working directory & data
wd <- "./"; setwd(wd)
pop <- readRDS("data/clean_data_RData/data_table_index_new_delete.RData")
df_list <- readRDS("data/att_first28.RData")
death   <- readRDS("data/GBD_death.RDS")
death <- death %>% filter(syndrome == "All infections")
# Ensure weights exist
if (!("wt" %in% names(pop))) pop$wt <- 1
# Settings
pathogens <- c("mdr_gnb", "mdr", "amr")
income_levels <- c("Overall", "High income", "Upper middle income", "Lower middle income", "Low income")
income_levels_prefixed <- c("1 High income", "2 Upper middle income", "3 Lower middle income", "4 Low income")
# Helpers
exposure_indicator <- function(x) {
if (is.null(x)) return(rep(NA_real_, length(x)))
if (is.numeric(x) || is.logical(x)) {
as.numeric(x == 1)
} else {
as.numeric(grepl("-resistant$", as.character(x), ignore.case = TRUE))
}
}
num_2 <- function(x, digits = 2) {
ifelse(is.na(x), NA, formatC(round(x, digits), format = "f", digits = digits))
}
fmt_ci_number <- function(est, lo, hi, digits = 0) {
est <- round(est, digits); lo <- round(lo, digits); hi <- round(hi, digits)
ifelse(is.na(lo) | is.na(hi),
as.character(est),
paste0(est, " [", lo, ", ", hi, "]"))
}
# PAF formatter: estimate with %, CI without %, 2 decimals
fmt_ci_percent_mix <- function(est, lo, hi, digits = 2) {
est_f <- paste0(num_2(100*est, digits))
lo_f  <- num_2(100*lo, digits)
hi_f  <- num_2(100*hi, digits)
ifelse(is.na(lo) | is.na(hi), est_f,
paste0(est_f, " [", lo_f, ", ", hi_f, "]"))
}
# Overall AHRs
overall_results <- tibble()
for (var_name in pathogens) {
df_used  <- df_list[[var_name]]
stopifnot(all(c("time", "event") %in% names(df_used)))
if (!("wt" %in% names(df_used))) df_used$wt <- 1
surv_formula <- as.formula(paste("Surv(time, event) ~", var_name))
model <- coxphw(
formula     = surv_formula,
data        = df_used,
template    = "AHR",
caseweights = df_used$wt,
robust      = TRUE
)
s  <- summary(model)
hr <- exp(s$coefficients)[1]
lo <- s$ci.lower[1]
up <- s$ci.upper[1]
overall_results <- bind_rows(
overall_results,
tibble(pathogen = var_name,
counts   = nrow(df_used),
Hazard_Ratio = hr,
Lower_CI     = lo,
Upper_CI     = up)
)
}
hr_tbl <- overall_results %>%
transmute(pathogen,
HR    = Hazard_Ratio,
HR_lo = Lower_CI,
HR_hi = Upper_CI)
# Overall PAF among all-cause deaths
is_death   <- pop$first28_death == 1
w_overall  <- if ("wt" %in% names(pop)) pop$wt else rep(1, nrow(pop))
get_p_cases_overall <- function(var_name) {
x <- pop[[var_name]]
exp_ind <- exposure_indicator(x)
num <- sum(w_overall[is_death] * exp_ind[is_death], na.rm = TRUE)
den <- sum(w_overall[is_death], na.rm = TRUE)
if (den == 0) NA_real_ else num / den
}
p_cases_vec <- setNames(vapply(pathogens, get_p_cases_overall, numeric(1)), pathogens)
bru_tbl <- hr_tbl %>%
mutate(
p_cases = p_cases_vec[pathogen],
PAF_overall = p_cases * (1 - 1 / HR),
PAF_overall_lo = p_cases * (1 - 1 / HR_lo),
PAF_overall_hi = p_cases * (1 - 1 / HR_hi)
)
# Income-stratified AHRs
strat_results <- tibble()
for (var_name in pathogens) {
df_ori <- df_list[[var_name]]
if (!("wt" %in% names(df_ori))) df_ori$wt <- 1
for (inc_pref in income_levels_prefixed) {
inc <- sub("^\\d+\\s+", "", inc_pref)
if (!inc %in% df_ori$country_income) next
df_used <- df_ori %>% filter(country_income == inc)
n_obs    <- nrow(df_used)
n_resist <- sum(grepl("resistant$", df_used[[var_name]]), na.rm = TRUE)
if (n_obs < 100)   next
if (n_resist < 30) next
surv_formula <- as.formula(paste("Surv(time, event) ~", var_name))
model <- coxphw(
formula     = surv_formula,
data        = df_used,
template    = "AHR",
caseweights = df_used$wt,
robust      = TRUE
)
s  <- summary(model)
hr <- exp(s$coefficients)[1]
lo <- s$ci.lower[1]
up <- s$ci.upper[1]
strat_results <- bind_rows(
strat_results,
tibble(pathogen = var_name,
income = inc_pref,
counts = n_obs,
Hazard_Ratio = hr,
Lower_CI = lo,
Upper_CI = up)
)
}
}
strat_results <- strat_results %>%
mutate(pathogen = factor(pathogen, levels = pathogens),
income   = factor(income, levels = income_levels_prefixed)) %>%
arrange(pathogen, income) %>%
mutate(income = sub("^\\d+\\s+", "", as.character(income)))
hr_inc_tbl <- strat_results %>%
transmute(income_level = income,
pathogen,
HR    = Hazard_Ratio,
HR_lo = Lower_CI,
HR_hi = Upper_CI)
# p_cases by income × pathogen
get_p_cases_by_income <- function(var_name, inc_label) {
dat <- if (inc_label == "Overall") pop else pop %>% filter(country_income == inc_label)
if (nrow(dat) == 0) return(NA_real_)
w <- if ("wt" %in% names(dat)) dat$wt else rep(1, nrow(dat))
is_death_loc <- dat$first28_death == 1
x <- dat[[var_name]]
exp_ind <- if (is.numeric(x) || is.logical(x)) {
as.numeric(x == 1)
} else {
as.numeric(grepl("-resistant$", as.character(x), ignore.case = TRUE))
}
num <- sum(w[is_death_loc] * exp_ind[is_death_loc], na.rm = TRUE)
den <- sum(w[is_death_loc], na.rm = TRUE)
if (den == 0) NA_real_ else num / den
}
p_cases_tbl <- tidyr::crossing(income_level = income_levels,
pathogen     = pathogens) %>%
mutate(p_cases = purrr::pmap_dbl(list(pathogen, income_level),
~ get_p_cases_by_income(..1, ..2)))
# HR-by-income with PAF
hr_by_income <- bind_rows(
hr_tbl %>% mutate(income_level = "Overall"),
hr_inc_tbl
) %>%
left_join(p_cases_tbl, by = c("income_level","pathogen")) %>%
mutate(
PAF_overall = p_cases * (1 - 1/HR),
PAF_overall_lo = p_cases * (1 - 1/HR_lo),
PAF_overall_hi = p_cases * (1 - 1/HR_hi)
) %>%
arrange(income_level, pathogen)
# Merge with deaths and apply Overall PAF to High/Low income (robust)
# Normalize income labels defensively
death <- death %>%
mutate(income_level = gsub("-", " ", income_level) |> trimws())
# If Overall is missing in death, create it by summation
if (!("Overall" %in% unique(death$income_level))) {
death_overall <- death %>%
group_by(syndrome) %>%
summarise(
deaths_est  = sum(deaths_est,  na.rm = TRUE),
deaths_low  = sum(deaths_low,  na.rm = TRUE),
deaths_high = sum(deaths_high, na.rm = TRUE),
.groups = "drop"
) %>%
mutate(income_level = "Overall") %>%
relocate(income_level)
death <- bind_rows(death, death_overall)
}
# Expand each death row to all pathogens (ensures pathogen present for all incomes)
death_expanded <- death %>%
select(income_level, syndrome, deaths_est, deaths_low, deaths_high) %>%
tidyr::crossing(tibble(pathogen = pathogens))
# Join HR/PAF by income & pathogen (may be NA for some income levels)
death_joined <- death_expanded %>%
left_join(hr_by_income, by = c("income_level", "pathogen"))
# Override
death_attr_income <- death_joined %>%
mutate(
attrib_deaths_est = deaths_est  * PAF_overall,
attrib_deaths_lo  = deaths_low  * PAF_overall_lo,
attrib_deaths_hi  = deaths_high * PAF_overall_hi
) %>%
arrange(
match(income_level, c("Overall","High income","Upper middle income","Lower middle income","Low income")),
match(pathogen, pathogens)
) %>%
dplyr::filter(income_level != "Low income")
# Clean table output
table_clean <- death_attr_income %>%
mutate(
Deaths = fmt_ci_number(deaths_est, deaths_low, deaths_high, digits = 0),
PAF_overall_fmt = fmt_ci_percent_mix(PAF_overall, PAF_overall_lo, PAF_overall_hi, digits = 2),
Attrib_deaths   = fmt_ci_number(attrib_deaths_est, attrib_deaths_lo, attrib_deaths_hi, digits = 0),
income_level    = factor(income_level,
levels = c("Overall","High income","Upper middle income","Lower middle income")),
pathogen        = factor(pathogen, levels = pathogens)
) %>%
arrange(income_level, pathogen) %>%
select(
income_level, pathogen,
Deaths,
PAF_overall = PAF_overall_fmt,
Attrib_deaths
)
print(table_clean)
## For table
# Clean and order table
tbl0 <- table_clean %>%
mutate(
pathogen = factor(
recode(pathogen,
"amr"     = "AMR",
"mdr"     = "MDR",
"mdr_gnb" = "MDR GNB"),
levels = c("AMR", "MDR", "MDR GNB")
),
income_level = factor(
income_level,
levels = c("Overall", "High income", "Upper middle income", "Lower middle income")
)
) %>%
arrange(income_level, pathogen) %>%
rename(
`Pathogens (all-cause deaths)` = pathogen,
`All-cause deaths`  = Deaths,
`Marginal population attributable fractions (%, 95%CI)` = PAF_overall,
`Attributable deaths` = Attrib_deaths
)
# Build group labels + stable IDs
group_labels <- tbl0 %>%
group_by(income_level) %>%
summarise(deaths_first = first(`All-cause deaths`), .groups = "drop") %>%
mutate(
income_level = as.character(income_level),
label = paste0(income_level, "<br>(", deaths_first, ")"),
id    = paste0("grp_", row_number())
)
# Remove 'All-cause deaths' from the body; drop income_level to avoid auto-grouping
tbl_show_body <- tbl0 %>%
mutate(`All-cause deaths` = "") %>%
select(-income_level, -`All-cause deaths`)
# ---------------------------
# Render gt and save (FINAL)
# ---------------------------
last_row <- nrow(tbl_show_body)
tbl <- gt(tbl_show_body) %>%
{
gt_obj <- .
gl <- group_labels
for (i in seq_len(nrow(gl))) {
row_idx <- which(as.character(tbl0$income_level) == gl$income_level[i])
gt_obj <- gt_obj %>%
tab_row_group(
label = md(gl$label[i]),
id    = gl$id[i],
rows  = row_idx
)
}
gt_obj
} %>%
row_group_order(group_labels$id) %>%
cols_align(align = "left",   columns = "Pathogens (all-cause deaths)") %>%
cols_align(align = "center", columns = c("Marginal population attributable fractions (%, 95%CI)", "Attributable deaths")) %>%
# Column labels in bold
tab_style(
style = cell_text(weight = "bold"),
locations = cells_column_labels(everything())
) %>%
# Hide all default body lines; keep header borders black
tab_options(
column_labels.border.top.color     = "black",
column_labels.border.top.width     = px(2),
column_labels.border.bottom.color  = "black",
column_labels.border.bottom.width  = px(2),
table_body.hlines.color            = "transparent",
table_body.hlines.width            = px(0),
# Turn off row-group borders (may be theme-dependent, so we also do an explicit style below)
row_group.border.top.color         = "transparent",
row_group.border.top.width         = px(0),
row_group.border.bottom.color      = "transparent",
row_group.border.bottom.width      = px(0),
# No outer borders
table.border.top.color             = "transparent",
table.border.top.width             = px(0),
table.border.bottom.color          = "transparent",
table.border.bottom.width          = px(0),
data_row.padding                   = px(0),
footnotes.padding                  = px(0)
) %>%
# Explicitly remove any top/bottom border on row-group labels (kills the "line under row 3")
tab_style(
style = cell_borders(
sides  = c("top", "bottom"),
color  = "transparent",
weight = px(0)
),
locations = cells_row_groups()
) %>%
# Hard reset: clear any body bottom borders that might exist
tab_style(
style = cell_borders(sides = "bottom", color = "transparent", weight = px(0)),
locations = cells_body(rows = everything(), columns = everything())
) %>%
# Add black rule below the FIRST row
tab_style(
style = cell_borders(sides = "bottom", color = "black", weight = px(0)),
locations = cells_body(rows = 1, columns = everything())
) %>%
# Add black rule below the LAST row
tab_style(
style = cell_borders(sides = "bottom", color = "black", weight = px(2)),
locations = cells_body(rows = last_row, columns = everything())
) %>%
# Fonts everywhere
tab_style(
style = cell_text(font = "Times New Roman", size = px(10)),
locations = list(
cells_title(groups = "title"),
cells_title(groups = "subtitle"),
cells_column_labels(),
cells_body(),
cells_footnotes(),
cells_source_notes()
)
) %>%
# Group labels: Times New Roman 10pt, bold (text only; borders already cleared above)
tab_style(
style = cell_text(font = "Times New Roman", size = px(10), weight = "bold"),
locations = cells_row_groups()
) %>%
# Column widths
cols_width(
1 ~ px(150),
2 ~ px(160),
3 ~ px(130)
) %>%
tab_source_note(
source_note = "Abbreviations: AMR = Antimicrobial Resistance, MDR = Multidrug Resistance, GNB = Gram-negative Bacteria, CI = Confidence Interval."
) %>%
tab_style(
style = cell_text(v_align = "middle"),
locations = list(
cells_body(columns = everything()),
cells_column_labels(columns = everything()),
cells_row_groups()
)
) %>%
tab_options(
footnotes.marks = c("#", "*", "†", "‡", "§"),
footnotes.sep   = " ",
footnotes.padding = px(0)
) %>%
tab_footnote(
footnote = "Data are from cause-specific mortality estimates of the Global Burden of Disease.",
locations = cells_column_labels(columns = "Pathogens (all-cause deaths)")
)
tbl
# Save
gtsave(tbl, "output/table/attrib_deaths_by_income.html")
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 1000) {
pdf_image <- image_read_pdf(input_pdf, density = dpi)
image_write(pdf_image, path = output_png, format = "png")
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file)
pdf_to_png(file, png_file)
}
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 1000) {
pdf_image <- image_read_pdf(input_pdf, density = dpi)
image_write(pdf_image, path = output_png, format = "png")
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("output/pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file)
pdf_to_png(file, png_file)
}
