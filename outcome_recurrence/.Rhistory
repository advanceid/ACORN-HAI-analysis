View(df_data)
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
crrSC,
cmprsk)
})
# Load the data
df_data <- readRDS("data/rp_data.RData")
# Initialize list to store results
df_used <- list()
system.time({
for (i in 1:3) {
df <- df_data[[i]]
# Convert outcome variable to numeric
df$event <- as.numeric(df$event)
# Create a function to check if a variable's value ends with "-resistant"
is_resistant <- function(x) {
ifelse(grepl("-resistant$", x), 1, 0)
}
# CRA, 3GCRE, CRE, CRP, VRE, MRSA
# Set factors
cols <- c("aci_car", "ent_car", "ent_thir", "pse_car", "entc_van", "sa_meth")
df[cols] <- lapply(df[cols], function(x) factor(is_resistant(x), levels = c(0, 1), labels = c("Absent", "Present")))
# Define explanatory variables
explanatory <- c("age_new", "sex",
"country_region", "country_income",
"hpd_admreason", "comorbidities_CCI",
"severity_score_scale",
"icu_hd_ap", "infection_types",
"aci_car", "ent_thir", "ent_car",
"pse_car", "entc_van", "sa_meth")
# Select relevant columns and remove rows with missing values
if (i == 3) {
df <- df %>%
select(time, time_new, event, event_new, all_of(explanatory)) %>%
filter(complete.cases(.), time > 0)
} else {
df <- df %>%
select(time, event, all_of(explanatory)) %>%
filter(complete.cases(.))
}
# Set reference
df$icu_hd_ap <- relevel(factor(df$icu_hd_ap), ref = "No")
df_used[[i]] <- df
}
})
# Save
saveRDS(df_used, "data/clean_data.RData")
###
View(df_used)
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
crrSC,
cmprsk)
})
# Load the data
df_data <- readRDS("data/rp_data.RData")
# Initialize list to store results
df_used <- list()
system.time({
for (i in 1:3) {
df <- df_data[[i]]
# Convert outcome variable to numeric
df$event <- as.numeric(df$event)
# Create a function to check if a variable's value ends with "-resistant"
is_resistant <- function(x) {
ifelse(grepl("-resistant$", x), 1, 0)
}
# CRA, 3GCRE, CRE, CRP, VRE, MRSA
# Set factors
cols <- c("aci_car", "ent_car", "ent_thir", "pse_car", "entc_van", "sa_meth")
df[cols] <- lapply(df[cols], function(x) factor(is_resistant(x), levels = c(0, 1), labels = c("Absent", "Present")))
# Define explanatory variables
explanatory <- c("age_new", "sex",
"country_region", "country_income",
"hpd_admreason", "comorbidities_CCI",
"severity_score_scale",
"icu_hd_ap", "infection_types",
"aci_car", "ent_thir", "ent_car",
"pse_car", "entc_van", "sa_meth")
# Select relevant columns and remove rows with missing values
if (i == 3) {
df <- df %>%
select(time, time_new, event, event_new, all_of(explanatory)) %>%
filter(complete.cases(.), time > 0)
} else {
df <- df %>%
select(time, event, all_of(explanatory)) %>%
filter(complete.cases(.), time <= 0)
}
# Set reference
df$icu_hd_ap <- relevel(factor(df$icu_hd_ap), ref = "No")
df_used[[i]] <- df
}
})
# Save
saveRDS(df_used, "data/clean_data.RData")
###
View(df_used)
View(df_used[[1]])
View(df_used[[2]])
159-14
14+146+25
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(magrittr,
dplyr,
tidyr,
gt,
gtsummary,
htmltools,
openxlsx)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
baseline <- readRDS("data/clean_data_RData/data_table_index_new_delete.RData")
episode <- readRDS("data/clean_data_RData/ast_all.RData")
# Filter episodes with both values 1 and 2
filter_multi_episodes <- function(data, col_name) {
valid_ids <- data %>%
group_by(recordid) %>%
filter(any(.data[[col_name]] == 1) & any(.data[[col_name]] == 2)) %>%
pull(recordid) %>%
unique()
data %>%
filter(recordid %in% valid_ids & .data[[col_name]] %in% c(1,2))
}
id_vap <- baseline$recordid[grepl("VAP", baseline$infection_types)]
id_bsi <- baseline$recordid[grepl("BSI$", baseline$infection_types)]
# Filter episodes for VAP and BSI
vap_episode <- episode %>% filter(recordid %in% id_vap)
bsi_episode <- episode %>% filter(recordid %in% id_bsi)
# Episodes with both 1 and 2 for VAP and BSI
df_vap_recur <- filter_multi_episodes(vap_episode, "f07m_vapc")
df_bsi_recur <- filter_multi_episodes(bsi_episode, "f07m_bsic")
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(magrittr,
dplyr,
tidyr,
gt,
gtsummary,
htmltools,
openxlsx)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
baseline <- readRDS("data/clean_data_RData/data_table_index_new_delete.RData")
episode <- readRDS("data/clean_data_RData/ast_all.RData")
# Filter episodes with both values 1 and 2
filter_multi_episodes <- function(data, col_name) {
valid_ids <- data %>%
group_by(recordid) %>%
filter(any(.data[[col_name]] == 1) & any(.data[[col_name]] == 2)) %>%
pull(recordid) %>%
unique()
data %>%
filter(recordid %in% valid_ids & .data[[col_name]] %in% c(1,2))
}
id_vap <- baseline$recordid[grepl("VAP", baseline$infection_types)]
id_bsi <- baseline$recordid[grepl("BSI$", baseline$infection_types)]
# Filter episodes for VAP and BSI
vap_episode <- episode %>% filter(recordid %in% id_vap)
bsi_episode <- episode %>% filter(recordid %in% id_bsi)
# Episodes with both 1 and 2 for VAP and BSI
df_vap_recur <- filter_multi_episodes(vap_episode, "f07m_vapc")
df_bsi_recur <- filter_multi_episodes(bsi_episode, "f07m_bsic")
# Only 1
get_remain_episode <- function(episode_data, recur_data) {
episode_data %>%
filter(!recordid %in% recur_data$recordid) %>%
group_by(recordid) %>%
slice_min(order_by = as.Date(spec_date), n = 1, with_ties = FALSE) %>%
ungroup() %>%
select(recordid, spec_date)
}
df_vap_remain <- get_remain_episode(vap_episode, df_vap_recur)
df_bsi_remain <- get_remain_episode(bsi_episode, df_bsi_recur)
# ------------------
# BSI persistence
matched_org <- df_bsi_recur %>%
filter(f07m_bsic %in% c(1,2)) %>%
group_by(recordid, org_names_all) %>%
summarise(has_1 = any(f07m_bsic == 1),
has_2 = any(f07m_bsic == 2),
.groups = "drop") %>%
filter(has_1 & has_2)
# ris_
antibiotic_cols <- grep("^ris_", colnames(df_bsi_recur), value = TRUE)
# recordid, org_names_all, ris_
df_bsi_check <- df_bsi_recur %>%
semi_join(matched_org, by = c("recordid", "org_names_all")) %>%
filter(f07m_bsic %in% c(1,2)) %>%
group_by(recordid, org_names_all) %>%
summarise(across(all_of(antibiotic_cols), ~ n_distinct(.x) == 1),
.groups = "drop")
consistent_antibiotic <- df_bsi_check %>%
rowwise() %>%
filter(all(c_across(all_of(antibiotic_cols)))) %>%
ungroup() %>%
select(recordid, org_names_all)
df_bsi_persist <- df_bsi_recur %>%
semi_join(consistent_antibiotic, by = c("recordid", "org_names_all")) %>%
filter(f07m_bsic %in% c(1,2))
# ------------
# Function to calculate duration between spec_dates (generalized)
calculate_duration <- function(data, id_col, event_col, date_col, prefix) {
data %>%
group_by(across(all_of(c(id_col, event_col)))) %>%
summarise(first_date = min(as.Date(.data[[date_col]])), .groups = "drop") %>%
pivot_wider(names_from = all_of(event_col),
values_from = first_date,
names_prefix = "spec_date_") %>%
mutate(!!paste0("duration_", prefix) := as.numeric(.data[["spec_date_2"]] -
.data[["spec_date_1"]])) %>%
select(all_of(id_col), starts_with("spec_date_"), starts_with("duration_"))
}
#
bsi_persist_duration <- calculate_duration(df_bsi_persist, "recordid", "f07m_bsic", "spec_date", "bsi_persist")
vap_recur_duration <- calculate_duration(df_vap_recur, "recordid", "f07m_vapc", "spec_date", "vap_recur")
bsi_recur_duration <- calculate_duration(df_bsi_recur, "recordid", "f07m_bsic", "spec_date", "bsi_recur")
# Add baseline
process_recurrence <- function(baseline_df, ids, duration_df, indicator_name) {
baseline_df %>%
filter(recordid %in% ids) %>%
mutate("{{indicator_name}}" := ifelse(recordid %in% duration_df$recordid, 1, 0)) %>%
left_join(duration_df, by = "recordid")
}
#
vap_recur <- process_recurrence(baseline, id_vap, vap_recur_duration, recurrence)
bsi_recur <- process_recurrence(baseline, id_bsi, bsi_recur_duration, recurrence)
# Function to fill missing spec_date_1 with spec_date from remain episodes (only 1)
fill_spec_date <- function(recur_df, remain_df, spec_date_col = "spec_date") {
recur_df %>%
left_join(remain_df %>% select(recordid, remain_spec_date = !!sym(spec_date_col)), by = "recordid") %>%
mutate(spec_date_1 = if_else(is.na(spec_date_1), remain_spec_date, spec_date_1)) %>%
select(-remain_spec_date)
}
3026-2802
224-185
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
crrSC,
cmprsk)
})
# Load the data
df_data <- readRDS("data/rp_data.RData")
# Initialize list to store results
df_used <- list()
system.time({
for (i in 1:3) {
df <- df_data[[i]]
# Convert outcome variable to numeric
df$event <- as.numeric(df$event)
# Create a function to check if a variable's value ends with "-resistant"
is_resistant <- function(x) {
ifelse(grepl("-resistant$", x), 1, 0)
}
# CRA, 3GCRE, CRE, CRP, VRE, MRSA
# Set factors
cols <- c("aci_car", "ent_car", "ent_thir", "pse_car", "entc_van", "sa_meth")
df[cols] <- lapply(df[cols], function(x) factor(is_resistant(x), levels = c(0, 1), labels = c("Absent", "Present")))
# Define explanatory variables
explanatory <- c("age_new", "sex",
"country_region", "country_income",
"hpd_admreason", "comorbidities_CCI",
"severity_score_scale",
"icu_hd_ap", "infection_types",
"aci_car", "ent_thir", "ent_car",
"pse_car", "entc_van", "sa_meth")
# Select relevant columns and remove rows with missing values
if (i == 3) {
df <- df %>%
select(time, time_new, event, event_new, all_of(explanatory)) %>%
filter(complete.cases(.), time > 0)
} else {
df <- df %>%
select(time, event, all_of(explanatory)) %>%
filter(complete.cases(.), time <= 0)
}
# Set reference
df$icu_hd_ap <- relevel(factor(df$icu_hd_ap), ref = "No")
df_used[[i]] <- df
}
})
# Save
saveRDS(df_used, "data/clean_data.RData")
###
View(df_used)
View(df_used[[1]])
View(df_data)
2026-2851
3026-2851
3+149
152+26
49-3
46+26
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(magrittr,
dplyr,
tidyr,
gt,
gtsummary,
htmltools,
openxlsx)
})
# Define working directory
wd <- "./"
setwd(wd)
# Load data
baseline <- readRDS("data/clean_data_RData/data_table_index_new_delete.RData")
episode <- readRDS("data/clean_data_RData/ast_all.RData")
# Filter episodes with both values 1 and 2
filter_multi_episodes <- function(data, col_name) {
valid_ids <- data %>%
group_by(recordid) %>%
filter(any(.data[[col_name]] == 1) & any(.data[[col_name]] == 2)) %>%
pull(recordid) %>%
unique()
data %>%
filter(recordid %in% valid_ids & .data[[col_name]] %in% c(1,2))
}
id_vap <- baseline$recordid[grepl("VAP", baseline$infection_types)]
id_bsi <- baseline$recordid[grepl("BSI$", baseline$infection_types)]
# Filter episodes for VAP and BSI
vap_episode <- episode %>% filter(recordid %in% id_vap)
bsi_episode <- episode %>% filter(recordid %in% id_bsi)
# Episodes with both 1 and 2 for VAP and BSI
df_vap_recur <- filter_multi_episodes(vap_episode, "f07m_vapc")
df_bsi_recur <- filter_multi_episodes(bsi_episode, "f07m_bsic")
# Only 1
get_remain_episode <- function(episode_data, recur_data) {
episode_data %>%
filter(!recordid %in% recur_data$recordid) %>%
group_by(recordid) %>%
slice_min(order_by = as.Date(spec_date), n = 1, with_ties = FALSE) %>%
ungroup() %>%
select(recordid, spec_date)
}
df_vap_remain <- get_remain_episode(vap_episode, df_vap_recur)
df_bsi_remain <- get_remain_episode(bsi_episode, df_bsi_recur)
# ------------------
# BSI persistence
matched_org <- df_bsi_recur %>%
filter(f07m_bsic %in% c(1,2)) %>%
group_by(recordid, org_names_all) %>%
summarise(has_1 = any(f07m_bsic == 1),
has_2 = any(f07m_bsic == 2),
.groups = "drop") %>%
filter(has_1 & has_2)
# ris_
antibiotic_cols <- grep("^ris_", colnames(df_bsi_recur), value = TRUE)
# recordid, org_names_all, ris_
df_bsi_check <- df_bsi_recur %>%
semi_join(matched_org, by = c("recordid", "org_names_all")) %>%
filter(f07m_bsic %in% c(1,2)) %>%
group_by(recordid, org_names_all) %>%
summarise(across(all_of(antibiotic_cols), ~ n_distinct(.x) == 1),
.groups = "drop")
consistent_antibiotic <- df_bsi_check %>%
rowwise() %>%
filter(all(c_across(all_of(antibiotic_cols)))) %>%
ungroup() %>%
select(recordid, org_names_all)
df_bsi_persist <- df_bsi_recur %>%
semi_join(consistent_antibiotic, by = c("recordid", "org_names_all")) %>%
filter(f07m_bsic %in% c(1,2))
# ------------
# Function to calculate duration between spec_dates (generalized)
calculate_duration <- function(data, id_col, event_col, date_col, prefix) {
data %>%
group_by(across(all_of(c(id_col, event_col)))) %>%
summarise(first_date = min(as.Date(.data[[date_col]])), .groups = "drop") %>%
pivot_wider(names_from = all_of(event_col),
values_from = first_date,
names_prefix = "spec_date_") %>%
mutate(!!paste0("duration_", prefix) := as.numeric(.data[["spec_date_2"]] -
.data[["spec_date_1"]])) %>%
select(all_of(id_col), starts_with("spec_date_"), starts_with("duration_"))
}
#
bsi_persist_duration <- calculate_duration(df_bsi_persist, "recordid", "f07m_bsic", "spec_date", "bsi_persist")
vap_recur_duration <- calculate_duration(df_vap_recur, "recordid", "f07m_vapc", "spec_date", "vap_recur")
bsi_recur_duration <- calculate_duration(df_bsi_recur, "recordid", "f07m_bsic", "spec_date", "bsi_recur")
# Add baseline
process_recurrence <- function(baseline_df, ids, duration_df, indicator_name) {
baseline_df %>%
filter(recordid %in% ids) %>%
mutate("{{indicator_name}}" := ifelse(recordid %in% duration_df$recordid, 1, 0)) %>%
left_join(duration_df, by = "recordid")
}
#
vap_recur <- process_recurrence(baseline, id_vap, vap_recur_duration, recurrence)
bsi_recur <- process_recurrence(baseline, id_bsi, bsi_recur_duration, recurrence)
# Function to fill missing spec_date_1 with spec_date from remain episodes (only 1)
fill_spec_date <- function(recur_df, remain_df, spec_date_col = "spec_date") {
recur_df %>%
left_join(remain_df %>% select(recordid, remain_spec_date = !!sym(spec_date_col)), by = "recordid") %>%
mutate(spec_date_1 = if_else(is.na(spec_date_1), remain_spec_date, spec_date_1)) %>%
select(-remain_spec_date)
}
6555-6384
171-14-146
# Clear
rm(list = ls())
# Load packages
suppressPackageStartupMessages({
require(pacman)
pacman::p_load(dplyr,
magrittr,
crrSC,
cmprsk)
})
# Load the data
df_data <- readRDS("data/rp_data.RData")
# Initialize list to store results
df_used <- list()
system.time({
for (i in 1:3) {
df <- df_data[[i]]
# Convert outcome variable to numeric
df$event <- as.numeric(df$event)
# Create a function to check if a variable's value ends with "-resistant"
is_resistant <- function(x) {
ifelse(grepl("-resistant$", x), 1, 0)
}
# CRA, 3GCRE, CRE, CRP, VRE, MRSA
# Set factors
cols <- c("aci_car", "ent_car", "ent_thir", "pse_car", "entc_van", "sa_meth")
df[cols] <- lapply(df[cols], function(x) factor(is_resistant(x), levels = c(0, 1), labels = c("Absent", "Present")))
# Define explanatory variables
explanatory <- c("age_new", "sex",
"country_region", "country_income",
"hpd_admreason", "comorbidities_CCI",
"severity_score_scale",
"icu_hd_ap", "infection_types",
"aci_car", "ent_thir", "ent_car",
"pse_car", "entc_van", "sa_meth")
# Select relevant columns and remove rows with missing values
if (i == 3) {
df <- df %>%
select(time, time_new, event, event_new, all_of(explanatory)) %>%
filter(complete.cases(.), time > 0)
} else {
df <- df %>%
select(time, event, all_of(explanatory)) %>%
filter(complete.cases(.), time > 0)
}
# Set reference
df$icu_hd_ap <- relevel(factor(df$icu_hd_ap), ref = "No")
df_used[[i]] <- df
}
})
# Save
saveRDS(df_used, "data/clean_data.RData")
###
View(df_used)
6555-6225
330-14-146
# Load package
library(magick)
# Function to crop PDFs using pdfcrop
crop_pdf <- function(input_pdf) {
command <- paste("pdfcrop", shQuote(input_pdf), shQuote(input_pdf))
system(command)
message("Cropped PDF saved to: ", input_pdf)
}
# Function to convert cropped PDFs to PNG
pdf_to_png <- function(input_pdf, output_png, dpi = 1000) {
pdf_image <- image_read_pdf(input_pdf, density = dpi)
image_write(pdf_image, path = output_png, format = "png")
message("Converted PDF to PNG: ", output_png)
}
# Locate and process all PDF files in the output folder
output_files <- list.files("pdf/", pattern = "*\\.pdf$", full.names = TRUE)
# Loop through each PDF file, crop, and convert to PNG
for (file in output_files) {
# Crop the PDF
crop_pdf(file)
# Convert to PNG
png_file <- sub("\\.pdf$", ".png", file)
pdf_to_png(file, png_file)
}
